<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>éƒ¨éšŠé»åç®¡ç†ç³»çµ± v2.6</title>
<style>
:root{
  --primary: #f5a962;
  --bg: #f9f7f3;
  --card: #ffffff;
  --text: #3d3d3d;
  --text-light: #7f7f7f;
  --border: #ebe7e0;
  --danger: #e74c3c;
  --success: #27ae60;
  --warning: #f39c12;
  --info: #3498db;
  --purple: #9b59b6;
}

*{box-sizing:border-box}

body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
  margin:0;
  padding:0;
  text-align:center;
  user-select:none;
  -webkit-tap-highlight-color:transparent;
  padding-bottom:80px; /* åº•éƒ¨ç©ºé–“ */
}

/* ========== é é¢çµæ§‹ ========== */
.page-container{
  max-width:800px;
  margin:0 auto;
  padding:15px;
}

/* ========== é ‚éƒ¨ Header ========== */
.header-section{
  background:var(--card);
  border-radius:16px;
  padding:20px;
  margin-bottom:15px;
  box-shadow:0 4px 12px rgba(0,0,0,0.03);
  border:1px solid var(--border);
  text-align:left;
}

.page-title{
  font-size:1.4rem;
  font-weight:800;
  color:var(--text);
  margin:0 0 10px 0;
  display:flex;
  align-items:center;
  gap:8px;
}

.search-input{
  width:100%;
  padding:12px;
  border:2px solid var(--border);
  border-radius:12px;
  background:var(--bg);
  font-size:1rem;
  text-align:center;
  transition:0.2s;
}
.search-input:focus{ outline:none; border-color:var(--primary); background:#fff; }

/* ========== æ•¸æ“šå„€è¡¨æ¿ ========== */
.stats-dashboard {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    margin-bottom: 15px;
}

.stat-card {
    background: var(--card);
    padding: 10px 5px;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.04);
    border: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.stat-label { font-size: 0.75rem; color: var(--text-light); margin-bottom: 4px; font-weight: 600; }
.stat-value { font-size: 1.4rem; font-weight: 800; line-height: 1.1; }

.val-total { color: var(--text); }
.val-present { color: var(--success); }
.val-excuse { color: var(--warning); }
.val-absent { color: var(--danger); }

/* ========== éšç´šçµ±è¨ˆèˆ‡é€²åº¦æ¢ ========== */
.rank-box {
    background: var(--card);
    border-radius: 12px;
    padding: 10px;
    margin-bottom: 15px;
    border: 1px solid var(--border);
    font-size: 0.85rem;
}
.rank-table { width: 100%; border-collapse: collapse; }
.rank-table th { color: var(--text-light); font-weight: 600; padding: 4px; }
.rank-table td { font-weight: 700; padding: 6px 4px; border-top: 1px solid var(--border); }

.progress-container { height: 8px; width: 100%; display: flex; border-radius: 4px; overflow: hidden; margin-top: 10px; }
.pb-seg { height: 100%; }

/* ========== æ§åˆ¶æŒ‰éˆ•å€ ========== */
.control-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-bottom: 20px;
}

.action-btn {
    padding: 12px;
    border: none;
    border-radius: 12px;
    font-weight: 700;
    font-size: 0.95rem;
    cursor: pointer;
    color: white;
    box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: 0.1s;
}
.action-btn:active { transform: scale(0.96); }

/* ========== é»ååˆ—è¡¨ ========== */
.roster-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
    gap: 8px;
    padding-bottom: 20px;
}

.roster-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    min-height: 80px;
    padding: 6px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    position: relative;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
}
.roster-card:active { transform: scale(0.95); }

/* éšç´šæ¢ */
.rank-strip { position: absolute; top: 0; left: 0; right: 0; height: 4px; border-radius: 12px 12px 0 0; }
.rs-off { background: var(--danger); }
.rs-nco { background: var(--info); }
.rs-sol { background: var(--success); }
.rs-tra { background: var(--purple); }

.card-name { font-size: 1rem; font-weight: 700; color: var(--text); z-index: 1; margin-top: 4px; }
.card-sub { font-size: 0.75rem; color: var(--text-light); }

/* ç‹€æ…‹æ¨£å¼ */
.st-pre { background: #f0f2f5; opacity: 0.6; }
.st-pre .card-name { text-decoration: line-through; color: var(--text-light); }
.st-pre::after { content: 'âœ“'; position: absolute; font-size: 2rem; color: var(--success); opacity: 0.3; }

.st-exc { background: #fff8e1; border: 1px solid var(--warning); }
.tag-exc { 
    background: var(--warning); color: white; font-size: 0.7rem; 
    padding: 2px 6px; border-radius: 4px; margin-top: 4px; 
    max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

.icon-lock { position: absolute; top: 5px; right: 5px; font-size: 0.8rem; }
.time-stamp { position: absolute; bottom: 3px; right: 5px; font-size: 0.6rem; opacity: 0.7; }

/* åˆ†éš”ç·š */
.sep-row { grid-column: 1 / -1; display: flex; align-items: center; gap: 10px; margin: 15px 0 5px 0; color: var(--text-light); font-weight: 600; font-size: 0.9rem; }
.sep-line { flex: 1; height: 1px; background: var(--border); }

/* ========== Modal å½ˆçª— ========== */
.modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 200; backdrop-filter: blur(3px); }
.modal.show { display: flex; animation: fadeIn 0.2s; }
.modal-box { background: var(--card); width: 90%; max-width: 360px; border-radius: 16px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }

/* äº‹æ•…æŒ‰éˆ•ç¶²æ ¼ */
.modal-options { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin: 15px 0; }
.opt-btn { 
    padding: 12px 0; border: none; border-radius: 8px; 
    font-weight: 600; color: white; cursor: pointer; font-size: 0.95rem; 
    transition: 0.1s;
}
.opt-btn:active { transform: scale(0.95); opacity: 0.9; }

/* ========== è¨­å®š/æ­·å²é¢æ¿ ========== */
.panel-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; opacity: 0; pointer-events: none; transition: 0.3s; }
.panel-overlay.show { opacity: 1; pointer-events: auto; }
.panel-content { 
    position: fixed; bottom: 0; left: 0; right: 0; background: var(--card); 
    border-radius: 20px 20px 0 0; padding: 20px; max-height: 85vh; overflow-y: auto; 
    transform: translateY(100%); transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); 
}
.panel-overlay.show .panel-content { transform: translateY(0); }

.input-group { margin-bottom: 15px; text-align: left; }
.form-control { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); font-size: 1rem; }
textarea.form-control { resize: vertical; }

/* æµ®å‹•æŒ‰éˆ• */
.fab-container { position: fixed; top: 15px; right: 15px; z-index: 90; display: flex; gap: 8px; }
.fab-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.15); font-size: 1.2rem; cursor: pointer; }

/* Toast */
.toast { position: fixed; bottom: 30px; left: 50%; transform: translate(-50%, 20px); background: #333; color: white; padding: 10px 20px; border-radius: 30px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 300; }
.toast.show { opacity: 1; transform: translate(-50%, 0); }

/* äº‹æ•…æ˜ç´°æ¿ */
.detail-board { background: #fff8f0; border: 1px solid #ffe0b2; border-radius: 12px; padding: 12px; margin-bottom: 15px; text-align: left; display: none; }
.detail-item { font-size: 0.9rem; margin-bottom: 4px; color: var(--text); line-height: 1.4; }

@keyframes fadeIn { from{opacity:0} to{opacity:1} }
</style>
</head>
<body>

<!-- é ‚éƒ¨æŒ‰éˆ• -->
<div class="fab-container">
    <button class="fab-btn" onclick="togglePanel('setup-panel')">âš™ï¸</button>
    <button class="fab-btn" onclick="togglePanel('history-panel')">ğŸ“…</button>
    <button class="fab-btn" onclick="togglePanel('help-panel')">â”</button>
</div>

<div class="page-container">
    
    <!-- æ¨™é¡Œèˆ‡æœå°‹ -->
    <div class="header-section">
        <h1 class="page-title">ğŸ“ éƒ¨éšŠé»åç³»çµ± <span style="font-size:0.8rem;background:var(--primary);color:white;padding:2px 8px;border-radius:10px">v2.6</span></h1>
        <input type="text" id="search-input" class="search-input" placeholder="ğŸ” è¼¸å…¥å§“åå¿«é€ŸæŸ¥æ‰¾..." oninput="filterRoster()">
    </div>

    <!-- å„€è¡¨æ¿ -->
    <div class="stats-dashboard">
        <div class="stat-card">
            <span class="stat-label">æ‡‰åˆ°</span><span class="stat-value val-total" id="stat-total">0</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">å·²åˆ°</span><span class="stat-value val-present" id="stat-present">0</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">äº‹æ•…</span><span class="stat-value val-excuse" id="stat-excuse">0</span>
        </div>
        <div class="stat-card" style="background:#fff5f5;border-color:#ffccd5">
            <span class="stat-label">æœªåˆ°</span><span class="stat-value val-absent" id="stat-absent">0</span>
        </div>
    </div>

    <!-- éšç´šçµ±è¨ˆ -->
    <div class="rank-box">
        <div class="progress-container" id="p-bar"></div>
        <table class="rank-table" style="margin-top:10px">
            <thead><tr><th>éšç´š</th><th>æ‡‰åˆ°</th><th style="color:var(--success)">å¯¦åˆ°</th><th style="color:var(--warning)">äº‹æ•…</th><th style="color:var(--danger)">æœªåˆ°</th></tr></thead>
            <tbody id="rank-stats-body"></tbody>
        </table>
    </div>

    <!-- äº‹æ•…æ˜ç´° -->
    <div id="detail-board" class="detail-board">
        <strong style="color:#d35400">ğŸ“Œ äº‹æ•…æ˜ç´°ï¼š</strong>
        <div id="detail-tags" style="margin-top:6px"></div>
    </div>

    <!-- æŒ‰éˆ•å€ -->
    <div class="control-grid">
        <button class="action-btn" id="mode-btn" onclick="toggleMode()" style="background:var(--text);grid-column:1/-1">âš ï¸ äº‹æ•…æ¨¡å¼ï¼šé—œ</button>
        <button class="action-btn" style="background:var(--success)" onclick="markAllPresent()">âš¡ é¤˜å“¡å…¨åˆ°</button>
        <button class="action-btn" style="background:var(--danger)" onclick="showMissing()">ğŸ“¢ æŸ¥æœªåˆ°</button>
        <button class="action-btn" style="background:var(--info)" onclick="toggleSort()" id="sort-btn">ğŸ”ƒ æ’åºï¼šåŸåº</button>
        <button class="action-btn" style="background:var(--text-light)" onclick="resetAll()">ğŸ”„ é‡ç½®ç‹€æ…‹</button>
    </div>

    <div style="display:flex;gap:10px;margin-bottom:20px">
        <button class="action-btn" style="flex:1;background:var(--purple)" onclick="copyCSMReport()">ğŸ“‹ ç‡Ÿå£«ç£å›å ±</button>
        <button class="action-btn" style="flex:1;background:var(--primary)" onclick="copyReport()">ğŸ“‹ å€¼æ˜Ÿå›å ±</button>
    </div>

    <!-- åå–® -->
    <div id="roster" class="roster-grid"></div>

</div>

<!-- è¨­å®šé¢æ¿ -->
<div id="setup-panel" class="panel-overlay">
    <div class="panel-content">
        <h2 style="margin:0 0 20px 0">âš™ï¸ ç³»çµ±è¨­å®š</h2>
        <div class="input-group">
            <label>å–®ä½åç¨±</label><input type="text" id="in-unit" class="form-control" placeholder="ä¾‹å¦‚ï¼šæ­¥ä¸€é€£">
        </div>
        <div class="input-group">
            <div style="display:flex;justify-content:space-between;margin-bottom:5px"><strong>ğŸ›‘ è»å®˜</strong><span style="color:var(--info);cursor:pointer" onclick="insertSep('in-off')">+åˆ†çµ„</span></div>
            <textarea id="in-off" class="form-control" style="height:60px"></textarea>
        </div>
        <div class="input-group">
            <div style="display:flex;justify-content:space-between;margin-bottom:5px"><strong>ğŸ”· å£«å®˜</strong><span style="color:var(--info);cursor:pointer" onclick="insertSep('in-nco')">+åˆ†çµ„</span></div>
            <textarea id="in-nco" class="form-control" style="height:60px"></textarea>
        </div>
        <div class="input-group">
            <div style="display:flex;justify-content:space-between;margin-bottom:5px"><strong>ğŸŸ© å£«å…µ</strong><span style="color:var(--info);cursor:pointer" onclick="insertSep('in-sol')">+åˆ†çµ„</span></div>
            <textarea id="in-sol" class="form-control" style="height:80px"></textarea>
        </div>
        <div class="input-group">
            <div style="display:flex;justify-content:space-between;margin-bottom:5px"><strong>ğŸŸ£ è¨“å“¡</strong><span style="color:var(--info);cursor:pointer" onclick="insertSep('in-tra')">+åˆ†çµ„</span></div>
            <textarea id="in-tra" class="form-control" style="height:60px"></textarea>
        </div>
        <div class="input-group">
            <label>è‡ªè¨‚äº‹æ•… (é€—è™Ÿåˆ†éš”)</label>
            <input type="text" id="in-reasons" class="form-control">
        </div>
        <button class="action-btn" style="width:100%;background:var(--success);margin-bottom:10px" onclick="saveData()">âœ… å„²å­˜è¨­å®š</button>
        <div style="display:flex;gap:10px">
            <button class="action-btn" style="flex:1;background:var(--text-light)" onclick="exportData()">ğŸ“¤ å‚™ä»½</button>
            <button class="action-btn" style="flex:1;background:var(--text-light)" onclick="importData()">ğŸ“¥ è®€å–</button>
        </div>
        <button class="action-btn" style="width:100%;background:transparent;color:var(--text);margin-top:10px" onclick="togglePanel('setup-panel')">é—œé–‰</button>
    </div>
</div>

<!-- æ­·å²é¢æ¿ -->
<div id="history-panel" class="panel-overlay">
    <div class="panel-content">
        <h2 style="margin:0 0 15px 0">ğŸ“… æ­·å²ç´€éŒ„ (<span id="history-count">0</span>)</h2>
        <div style="background:var(--bg);padding:15px;border-radius:10px;margin-bottom:15px">
            <input type="date" id="history-date" class="form-control" style="margin-bottom:10px">
            <select id="history-period" class="form-control" style="margin-bottom:10px">
                <option value="am">â˜€ï¸ ä¸Šåˆ</option><option value="pm">â›… ä¸‹åˆ</option><option value="night">ğŸŒ™ å¤œé–“</option>
            </select>
            <div style="display:flex;gap:10px">
                <button class="action-btn" style="flex:1;background:var(--success)" onclick="saveToDate()">ğŸ“¥ å­˜æª”</button>
                <button class="action-btn" style="flex:1;background:var(--primary)" onclick="loadFromDate()">ğŸ“¤ è®€å–</button>
            </div>
        </div>
        <button class="action-btn" style="width:100%;background:var(--info);margin-bottom:10px" onclick="showHistoryList()">ğŸ“œ æ‰€æœ‰ç´€éŒ„æ¸…å–®</button>
        <button class="action-btn" style="width:100%;background:var(--danger)" onclick="clearHistory()">ğŸ—‘ï¸ æ¸…ç©ºæ­·å²</button>
        <button class="action-btn" style="width:100%;background:transparent;color:var(--text);margin-top:10px" onclick="togglePanel('history-panel')">é—œé–‰</button>
    </div>
</div>

<!-- èªªæ˜é¢æ¿ -->
<div id="help-panel" class="panel-overlay">
    <div class="panel-content">
        <h2>ğŸ“– ä½¿ç”¨èªªæ˜</h2>
        <div style="text-align:left;line-height:1.6">
            <p><strong>1. è¨­å®šåå–®ï¼š</strong>å³ä¸Šè§’ âš™ï¸ è¨­å®šï¼Œè²¼ä¸Šåå­—(ç©ºæ ¼åˆ†éš”)ã€‚</p>
            <p><strong>2. é»åï¼š</strong>é»å¡ç‰‡åˆ‡æ›ç‹€æ…‹ã€‚é–‹å•Ÿã€Œäº‹æ•…æ¨¡å¼ã€å¯æ¨™è¨˜åŸå› ã€‚</p>
            <p><strong>3. é¡è‰²èªªæ˜ï¼š</strong>
                <br>ğŸŸ  ä¼‘å‡é¡ (ä¼‘å‡, å¤–å®¿...)
                <br>ğŸŸ¢ å‹¤å‹™é¡ (è¡›å“¨, å®‰å®˜...)
                <br>ğŸ”µ å…¬å‹™é¡ (å…¬å·®, å—è¨“...)
                <br>ğŸ”´ é†«ç™‚é¡ (è½‰è¨º, ä½é™¢...)
            </p>
            <p><strong>4. å›å ±ï¼š</strong>åº•éƒ¨æŒ‰éˆ•å¯ä¸€éµè¤‡è£½ã€‚</p>
        </div>
        <button class="action-btn" style="width:100%;background:var(--text-light);margin-top:20px" onclick="togglePanel('help-panel')">é—œé–‰</button>
    </div>
</div>

<!-- é»åå½ˆçª— -->
<div id="modal" class="modal">
    <div class="modal-box">
        <h3 id="m-name" style="margin:0 0 15px 0;text-align:center;font-size:1.3rem"></h3>
        <input type="text" id="note-input" class="form-control" placeholder="å‚™è¨» (å¦‚: 21æ”¶, ç™¼ç‡’...)" style="margin-bottom:10px">
        <div style="display:flex;gap:5px;margin-bottom:15px">
            <input id="custom-r" type="text" class="form-control" placeholder="è‡ªè¨‚åŸå› ">
            <button onclick="subCus()" style="width:60px;border:none;background:var(--info);color:white;border-radius:8px">OK</button>
        </div>
        <div class="modal-options" id="opts-container"></div>
        <label style="display:flex;align-items:center;gap:8px;justify-content:center;margin:15px 0;cursor:pointer">
            <input type="checkbox" id="lock-status" style="transform:scale(1.3)">
            <span>ğŸ”’ é–å®šç‹€æ…‹ (é‡ç½®æ™‚ä¿ç•™)</span>
        </label>
        <button class="action-btn" style="width:100%;background:#bdc3c7;color:#333" onclick="closeM()">å–æ¶ˆ</button>
    </div>
</div>

<!-- æ­·å²æ¸…å–®å½ˆçª— -->
<div id="his-list-modal" class="modal" style="z-index:250">
    <div class="modal-box" style="max-height:80vh;display:flex;flex-direction:column">
        <h3 style="margin-top:0">ğŸ“œ å­˜æª”ç´€éŒ„</h3>
        <div id="his-items-container" style="overflow-y:auto;flex:1;margin-bottom:15px;border:1px solid var(--border);border-radius:8px"></div>
        <button class="action-btn" style="background:#bdc3c7;color:#333" onclick="closeHisList()">é—œé–‰</button>
    </div>
</div>

<!-- Toast -->
<div id="toast" class="toast"></div>

<script>
const K_CUR='army_v2_cur',K_HIS='army_v2_his';
let D={o:[],n:[],s:[],t:[],st:{},nt:{},lck:{},tm:{},u:'',rs:''},isM=false,isSorted=false,cur='',reportStr='';
const DEFAULT_REASONS = "ä¼‘å‡,å¤–å®¿,è£œä¼‘,è¡›å“¨,å®‰å®˜,æˆ°æƒ…,å…¬å·®,å—è¨“,æ”¯æ´,è½‰è¨º,ä½é™¢,éš”é›¢";

document.addEventListener('DOMContentLoaded',()=>{
    document.getElementById('history-date').valueAsDate=new Date();
    load(); updateHisCount();
});

// UI Helpers
function showToast(msg) {
    const t = document.getElementById('toast');
    t.innerText = msg; t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), 2000);
}
function togglePanel(id) {
    const p = document.getElementById(id);
    if(p.classList.contains('show')) p.classList.remove('show');
    else {
        document.querySelectorAll('.panel-overlay').forEach(e=>e.classList.remove('show'));
        p.classList.add('show');
        if(id==='history-panel') updateHisCount();
    }
}

// Data Logic
function insertSep(id){
    const name = prompt("è¼¸å…¥åˆ†çµ„åç¨± (å¦‚: ä¸€æ’):");
    if(name){
        const el = document.getElementById(id);
        const val = el.value;
        const txt = ` ---${name}--- `;
        el.value = val.slice(0, el.selectionStart) + txt + val.slice(el.selectionEnd);
        saveData();
    }
}
function exportData(){
    const d=JSON.stringify({cur:JSON.parse(localStorage.getItem(K_CUR)||'{}'),his:JSON.parse(localStorage.getItem(K_HIS)||'{}')});
    navigator.clipboard.writeText(d).then(()=>showToast("âœ… å‚™ä»½ç¢¼å·²è¤‡è£½")).catch(()=>prompt("è¤‡è£½:",d));
}
function importData(){
    const s=prompt("è²¼ä¸Šå‚™ä»½ç¢¼:");
    if(s){try{const d=JSON.parse(s);localStorage.setItem(K_CUR,JSON.stringify(d.cur));localStorage.setItem(K_HIS,JSON.stringify(d.his));location.reload()}catch{alert("æ ¼å¼éŒ¯èª¤")}}
}
function saveData(){
    D.u=document.getElementById('in-unit').value.trim();
    D.rs=document.getElementById('in-reasons').value.trim();
    D.o=parse(document.getElementById('in-off').value);D.n=parse(document.getElementById('in-nco').value);D.s=parse(document.getElementById('in-sol').value);D.t=parse(document.getElementById('in-tra').value);
    persist();render();togglePanel('setup-panel');showToast("âœ… è¨­å®šå·²å„²å­˜");
}
function persist(){localStorage.setItem(K_CUR,JSON.stringify(D))}
function parse(t){return t?t.split(/[\s,ã€\n]+/).filter(x=>x.trim()):[]}
function load(){
    const r=localStorage.getItem(K_CUR);
    if(r){D=JSON.parse(r);fillSetup();render()}else{togglePanel('setup-panel')}
}
function fillSetup(){
    document.getElementById('in-unit').value=D.u||'';
    document.getElementById('in-reasons').value=D.rs||DEFAULT_REASONS;
    document.getElementById('in-off').value=D.o.join(' ');document.getElementById('in-nco').value=D.n.join(' ');document.getElementById('in-sol').value=D.s.join(' ');document.getElementById('in-tra').value=D.t.join(' ');
}

// Core Roster
function toggleMode(){ isM=!isM; document.getElementById('mode-btn').innerText=isM?"âš ï¸ äº‹æ•…æ¨¡å¼ï¼šé–‹":"âš ï¸ äº‹æ•…æ¨¡å¼ï¼šé—œ"; document.getElementById('mode-btn').style.background=isM?"var(--warning)":"var(--text)"; }
function toggleSort(){ isSorted=!isSorted; document.getElementById('sort-btn').innerText=isSorted?"ğŸ”ƒ æ’åºï¼šæœªåˆ°å„ªå…ˆ":"ğŸ”ƒ æ’åºï¼šåŸåº"; render(); }
function filterRoster(){ const k=document.getElementById('search-input').value.toLowerCase(); document.querySelectorAll('.roster-card').forEach(c=>c.style.display=c.innerText.toLowerCase().includes(k)?'flex':'none'); }

function markAllPresent(){
    if(confirm("å°‡æ‰€æœ‰æœªé»åè€…è¨­ç‚ºã€Œå¯¦åˆ°ã€ï¼Ÿ")){
        const t = new Date().toTimeString().slice(0,5);
        [...D.o,...D.n,...D.s,...D.t].forEach(n=>{ if(!D.st[n] && !n.startsWith('-')){ D.st[n]='p'; D.tm[n]=t; }});
        persist();render();showToast("âš¡ å·²å…¨è¨­ç‚ºå¯¦åˆ°");
    }
}
function resetAll(){
    if(confirm("é‡ç½®æ‰€æœ‰ç‹€æ…‹ï¼Ÿ(é–å®šè€…é™¤å¤–)")){
        [...D.o,...D.n,...D.s,...D.t].forEach(n=>{ if(!D.lck||!D.lck[n]){ delete D.st[n]; delete D.nt[n]; delete D.tm[n]; }});
        persist();render();showToast("ğŸ”„ é‡ç½®å®Œæˆ");
    }
}
function getAbsCount(){ return [...D.o,...D.n,...D.s,...D.t].filter(n=>!D.st[n]&&!n.startsWith('-')).length; }
function showMissing(){
    const m = [...D.o,...D.n,...D.s,...D.t].filter(n=>!D.st[n]&&!n.startsWith('-'));
    if(m.length===0) showToast("ğŸ‘ å…¨å“¡å·²åˆ°"); else alert(`æœªåˆ° (${m.length}):\n${m.join('ã€')}`);
}

// Render
function render(){
    const c=document.getElementById('roster'); c.innerHTML='';
    const groups = [{l:D.o,c:'rs-off'},{l:D.n,c:'rs-nco'},{l:D.s,c:'rs-sol'},{l:D.t,c:'rs-tra'}];
    let items = [];
    if(isSorted){
        groups.forEach(g=>g.l.forEach(n=>{if(!n.startsWith('-')&&!n.startsWith('#'))items.push({n,t:g.c})}));
        items.sort((a,b)=>{ const sc=(nm)=>!D.st[nm]?0:(D.st[nm]!=='p'?1:2); return sc(a.n)-sc(b.n) });
    }
    const mkCard = (n,cls) => {
        if(n.startsWith('-')||n.startsWith('#')){
            const d=document.createElement('div'); d.className='sep-row'; d.innerHTML=`<div class="sep-line"></div>${n.replace(/[-#]/g,'').trim()}<div class="sep-line"></div>`; return d;
        }
        const card = document.createElement('div');
        const st = D.st[n];
        card.className = `roster-card ${st==='p'?'st-pre':(st?'st-exc':'')}`;
        
        let sub='', name=n, m=n.match(/^(.*?)[ï¼ˆ\(](.*)[ï¼‰\)]$/);
        if(m){ name=m[1]; sub=m[2]; }

        let h = `<div class="rank-strip ${cls}"></div><div class="card-name">${name}</div>`;
        if(sub) h += `<div class="card-sub">${sub}</div>`;
        
        if(st && st!=='p') {
             // ç°¡å–®çš„é¡è‰²åˆ¤æ–·ç”¨æ–¼å¡ç‰‡ä¸Šçš„å°æ¨™ç±¤
             let bg = '#f39c12'; // Default Orange
             if(['è½‰è¨º','ä½é™¢','éš”é›¢'].some(k=>st.includes(k))) bg='#e74c3c';
             else if(['å…¬å·®','å—è¨“','æ”¯æ´'].some(k=>st.includes(k))) bg='#3498db';
             else if(['è¡›å“¨','å®‰å®˜','æˆ°æƒ…'].some(k=>st.includes(k))) bg='#27ae60';
             h += `<div class="tag-exc" style="background:${bg}">${st}</div>`;
        }
        if(D.nt && D.nt[n]) h += `<div class="card-sub" style="color:var(--primary)">ğŸ“${D.nt[n]}</div>`;
        if(D.lck && D.lck[n]) h += `<div class="icon-lock">ğŸ”’</div>`;
        if(D.tm && D.tm[n] && st==='p') h += `<div class="time-stamp">${D.tm[n]}</div>`;

        card.innerHTML = h;
        card.onclick = () => cardClick(n, name);
        return card;
    };

    if(isSorted) items.forEach(i=>c.appendChild(mkCard(i.n,i.t)));
    else groups.forEach(g=>g.l.forEach(n=>c.appendChild(mkCard(n,g.c))));
    
    updateStats(); filterRoster();
}

function cardClick(n, name){
    if(navigator.vibrate) navigator.vibrate(10);
    if(isM){
        cur=n; document.getElementById('m-name').innerText=name;
        document.getElementById('custom-r').value='';
        document.getElementById('note-input').value=D.nt[n]||'';
        document.getElementById('lock-status').checked=!!D.lck[n];
        renderOpts();
        document.getElementById('modal').classList.add('show');
    } else {
        if(D.lck[n]) return showToast("ğŸ”’ æ­¤äººå“¡å·²é–å®š");
        if(D.st[n]==='p') { delete D.st[n]; delete D.tm[n]; }
        else { D.st[n]='p'; D.tm[n]=new Date().toTimeString().slice(0,5); }
        persist(); render();
    }
}

// âš ï¸ é¡è‰²åˆ†é¡é‚è¼¯æ ¸å¿ƒ âš ï¸
function renderOpts(){
    const c=document.getElementById('opts-container'); c.innerHTML='';
    const rs=(D.rs||DEFAULT_REASONS).split(/[,ï¼Œ]/);
    rs.forEach(r=>{
        if(!r.trim())return;
        const b=document.createElement('button'); b.className='opt-btn'; b.innerText=r;
        let bg='#9b59b6'; // é è¨­ç´«
        // ç´…: é†«ç™‚
        if(['è½‰è¨º','ä½é™¢','éš”é›¢','ç™¼ç‡’','ç—…å‡'].some(k=>r.includes(k))) bg='#e74c3c';
        // è—: å…¬å‹™/å—è¨“
        else if(['å…¬å·®','å—è¨“','æ”¯æ´','å‡ºå·®'].some(k=>r.includes(k))) bg='#3498db';
        // ç¶ : å‹¤å‹™
        else if(['è¡›å“¨','å®‰å®˜','æˆ°æƒ…','å€¼æ˜Ÿ'].some(k=>r.includes(k))) bg='#27ae60';
        // æ©˜: ä¼‘å‡
        else if(['ä¼‘å‡','å¤–å®¿','è£œä¼‘'].some(k=>r.includes(k))) bg='#f39c12';
        
        b.style.background=bg;
        b.onclick=()=>setSt(r);
        c.appendChild(b);
    });
    const clr=document.createElement('button'); clr.className='opt-btn'; clr.innerText='æ¸…é™¤ç‹€æ…‹';
    clr.style.background='#95a5a6'; clr.style.gridColumn='1/-1'; clr.onclick=()=>setSt(null);
    c.appendChild(clr);
}

function subCus(){ const v=document.getElementById('custom-r').value.trim(); if(v) setSt(v); }
function setSt(v){
    D.st[cur]=v;
    const n=document.getElementById('note-input').value.trim();
    if(n)D.nt[cur]=n; else delete D.nt[cur];
    if(document.getElementById('lock-status').checked)D.lck[cur]=true; else delete D.lck[cur];
    if(v==='p'||!v) delete D.tm[cur];
    closeM(); persist(); render();
}
function closeM(){ document.getElementById('modal').classList.remove('show'); }

// Stats & Report
function updateStats(){
    const calc=(l)=>l.filter(n=>!n.startsWith('-')&&!n.startsWith('#')).reduce((a,n)=>{
        a.t++; const s=D.st[n];
        if(s==='p')a.p++; else if(s){ a.e++; if(!a.dt[s])a.dt[s]=[]; a.dt[s].push(n); }
        return a;
    },{t:0,p:0,e:0,dt:{}});
    const Ro=calc(D.o), Rn=calc(D.n), Rs=calc(D.s), Rt=calc(D.t);
    const T={t:Ro.t+Rn.t+Rs.t+Rt.t, p:Ro.p+Rn.p+Rs.p+Rt.p, e:Ro.e+Rn.e+Rs.e+Rt.e};
    const Abs=T.t-T.p-T.e;

    document.getElementById('stat-total').innerText=T.t; document.getElementById('stat-present').innerText=T.p;
    document.getElementById('stat-excuse').innerText=T.e; document.getElementById('stat-absent').innerText=Abs;

    const row=(n,d,i)=>`<tr><td>${i} ${n}</td><td>${d.t}</td><td style="color:var(--success)">${d.p}</td><td style="color:var(--warning)">${d.e}</td><td style="color:var(--danger)">${d.t-d.p-d.e}</td></tr>`;
    document.getElementById('rank-stats-body').innerHTML = row('è»å®˜',Ro,'ğŸ›‘')+row('å£«å®˜',Rn,'ğŸ”·')+row('å£«å…µ',Rs,'ğŸŸ©')+row('è¨“å“¡',Rt,'ğŸŸ£');
    
    if(T.t>0) document.getElementById('p-bar').innerHTML = `<div class="pb-seg" style="width:${(T.p/T.t)*100}%;background:var(--success)"></div><div class="pb-seg" style="width:${(T.e/T.t)*100}%;background:var(--warning)"></div><div class="pb-seg" style="width:${(Abs/T.t)*100}%;background:var(--danger)"></div>`;

    // Detail & Report
    const db=document.getElementById('detail-board'), dt=document.getElementById('detail-tags');
    dt.innerHTML='';
    const mergedDt={};
    [Ro,Rn,Rs,Rt].forEach(r=>{ for(let[k,a]of Object.entries(r.dt)){ if(!mergedDt[k])mergedDt[k]=[]; mergedDt[k].push(...a); }});
    
    if(T.e>0){
        db.style.display='block';
        for(let[k,arr]of Object.entries(mergedDt)){
            const ns=arr.map(x=>x.split(/[ï¼ˆ\(]/)[0]+(D.nt[x]?`[${D.nt[x]}]`:'')).join(' ');
            dt.innerHTML+=`<div class="detail-item"><strong>${k} (${arr.length}):</strong> ${ns}</div>`;
        }
    } else db.style.display='none';

    // Gen Report String
    let now=new Date();
    let r=`ã€éƒ¨éšŠé»åå›å ±ã€‘\nå–®ä½ï¼š${D.u||''}\næ™‚é–“ï¼š${now.getMonth()+1}/${now.getDate()} ${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}\n`;
    r+=`æ‡‰åˆ°ï¼š${T.t} (å®˜${Ro.t}å£«${Rn.t}å…µ${Rs.t}è¨“${Rt.t})\nå¯¦åˆ°ï¼š${T.p} (å®˜${Ro.p}å£«${Rn.p}å…µ${Rs.p}è¨“${Rt.p})\näº‹æ•…ï¼š${T.e} (å®˜${Ro.e}å£«${Rn.e}å…µ${Rs.e}è¨“${Rt.e})\næœªåˆ°ï¼š${Abs}\n----------------\n`;
    if(T.e>0){
        for(let[k,arr]of Object.entries(mergedDt)){
            const ns=arr.map(x=>x.split(/[ï¼ˆ\(]/)[0]+(D.nt[x]?`[${D.nt[x].replace(/2[14]æ”¶|07æ”¶/g,'')}]`:'')).join(' ');
            const l=arr.length, f=arr[0].split(/[ï¼ˆ\(]/)[0];
            r+=`${k}ï¼š${l}å“¡ (${l>1?f+'ç­‰'+l+'å“¡':ns})\n`;
        }
        r+=`\næ˜ç´°ï¼š\n`;
        for(let[k,arr]of Object.entries(mergedDt)) r+=`${k}: ${arr.map(x=>x.split(/[ï¼ˆ\(]/)[0]).join(' ')}\n`;
    } else r+="ç„¡äº‹æ•…äººå“¡\n";
    reportStr=r;
}

function copyReport(){ if(getAbsCount()>0)return alert("âš ï¸ é‚„æœ‰æœªé»åäººå“¡ï¼"); navigator.clipboard.writeText(reportStr).then(()=>showToast("âœ… å€¼æ˜Ÿå›å ±å·²è¤‡è£½")); }
function copyCSMReport(){ if(getAbsCount()>0)return alert("âš ï¸ é‚„æœ‰æœªé»åäººå“¡ï¼"); navigator.clipboard.writeText(reportStr).then(()=>showToast("âœ… ç‡Ÿå£«ç£å›å ±å·²è¤‡è£½")); }

// History
function getHis(){return JSON.parse(localStorage.getItem(K_HIS)||'{}')}
function updateHisCount(){document.getElementById('history-count').innerText=Object.keys(getHis()).length}
function saveToDate(){
    const d=document.getElementById('history-date').value; if(!d)return alert("é¸æ—¥æœŸ");
    const k=`${d}_${document.getElementById('history-period').value}`;
    const h=getHis(); h[k]=D; localStorage.setItem(K_HIS,JSON.stringify(h));
    updateHisCount(); showToast("âœ… å·²å­˜æª”");
}
function loadFromDate(){
    const k=`${document.getElementById('history-date').value}_${document.getElementById('history-period').value}`;
    const h=getHis(); if(h[k]){ D=h[k]; persist(); render(); togglePanel('history-panel'); showToast("âœ… è®€å–æˆåŠŸ"); } else alert("æŸ¥ç„¡ç´€éŒ„");
}
function showHistoryList(){
    const h=getHis(),c=document.getElementById('his-items-container');c.innerHTML='';
    Object.keys(h).sort().reverse().forEach(k=>{
        const d=document.createElement('div'); d.style.cssText='padding:12px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center';
        d.innerHTML=`<span>${k}</span> <button style="border:none;background:#e74c3c;color:white;padding:5px 10px;border-radius:5px" onclick="delHis('${k}')">åˆª</button>`;
        c.appendChild(d);
    });
    document.getElementById('his-list-modal').classList.add('show');
}
function delHis(k){if(confirm("åˆªé™¤?")){const h=getHis();delete h[k];localStorage.setItem(K_HIS,JSON.stringify(h));showHistoryList();updateHisCount();}}
function closeHisList(){document.getElementById('his-list-modal').classList.remove('show')}
function clearHistory(){if(confirm("æ¸…ç©º?")){localStorage.removeItem(K_HIS);updateHisCount();showToast("å·²æ¸…ç©º")}}
</script>
</body>
</html>
