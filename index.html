<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>éƒ¨éšŠé»åç³»çµ± v3.2</title>
<style>
:root{
  --bg: #f4f7f6;
  --card: #ffffff;
  --text: #333333;
  --text-light: #888888;
  --shadow: rgba(0,0,0,0.06);
  --border: #eeeeee;
}

*{box-sizing:border-box}

body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
  margin:0; padding:0;
  text-align:center; user-select:none; -webkit-tap-highlight-color:transparent;
  padding-bottom:100px;
}

.page-container{ max-width:800px; margin:0 auto; padding:15px; }

/* ========== Header å€åŸŸ ========== */
.header-section{
  background:var(--card); border-radius:20px; padding:16px 20px; margin-bottom:20px;
  box-shadow:0 4px 20px var(--shadow); display: flex; flex-direction: column; gap: 12px;
}
.header-top { display: flex; justify-content: space-between; align-items: center; }
.page-title{ font-size:1.3rem; font-weight:800; margin:0; display:flex; align-items:center; gap:8px; }
.ver-tag { font-size:0.7rem; background:#34495e; color:white; padding:3px 8px; border-radius:12px; }
.header-actions { display: flex; gap: 10px; }
.header-btn {
  width: 38px; height: 38px; border-radius: 50%; border: none; background: #f0f2f5;
  color: #555; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
}
.header-btn:active { transform: scale(0.9); background: #e0e0e0; }

/* ğŸ”¥ æ–°å¢ï¼šæ™‚æ®µè³‡è¨Šæ¬„æ¨£å¼ ğŸ”¥ */
.session-info-bar {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 10px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.95rem;
    font-weight: 700;
    color: #475569;
}
.period-badge {
    padding: 4px 12px;
    border-radius: 8px;
    color: white;
    font-size: 0.9rem;
    display: flex; align-items: center; gap: 5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
/* æ™‚æ®µé¡è‰² */
.p-am { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); } /* ä¸Šåˆæ©˜é»ƒ */
.p-pm { background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%); } /* ä¸‹åˆè—å¤© */
.p-night { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); } /* å¤œé–“ç´« */

.search-input{
  width:100%; padding:12px; border:2px solid transparent; background:#f0f2f5;
  border-radius:12px; font-size:1rem; text-align:center; color: var(--text);
}
.search-input:focus{ outline:none; background:#fff; border-color:#3498db; }

/* ========== çµ±è¨ˆå„€è¡¨æ¿ ========== */
.stats-dashboard { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
.stat-card { background: var(--card); padding: 12px 5px; border-radius: 16px; box-shadow: 0 4px 15px var(--shadow); display: flex; flex-direction: column; align-items: center; justify-content: center; }
.stat-label { font-size: 0.75rem; color: var(--text-light); margin-bottom: 4px; font-weight: 600; }
.stat-value { font-size: 1.4rem; font-weight: 800; line-height: 1; }

/* ========== éšç´šçµ±è¨ˆè¡¨ ========== */
.rank-box {
    background: var(--card); border-radius: 16px; padding: 0 0 15px 0;
    margin-bottom: 20px; box-shadow: 0 4px 15px var(--shadow); overflow: hidden;
}
.progress-container {
    height: 8px; width: 90%; display: flex; background: #f0f0f0; 
    margin: 15px auto 10px auto; border-radius: 10px; overflow: hidden;
}
.pb-seg { height: 100%; transition: width 0.3s; }
.rank-table { width: 90%; margin: 0 auto; border-collapse: collapse; }
.rank-table th { color: #999; font-weight: 600; padding: 10px 5px; font-size: 0.9rem; border-bottom: 1px solid #f0f0f0; }
.rank-table td { font-weight: 700; padding: 12px 5px; font-size: 1rem; border-bottom: 1px solid #f0f0f0; color: #444; }
.rank-table tr:last-child td { border-bottom: none; }

/* åœ–ç¤º */
.icon-shape { display: inline-block; vertical-align: middle; margin-right: 8px; }
.shape-off { width: 14px; height: 14px; background: #e74c3c; clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%); }
.shape-nco { width: 10px; height: 10px; background: #3498db; transform: rotate(45deg); margin: 0 10px 0 4px; }
.shape-sol { width: 12px; height: 12px; background: #7cb342; border-radius: 2px; }
.shape-tra { width: 13px; height: 13px; background: #9b59b6; border-radius: 50%; }
.txt-green { color: #4caf50; } .txt-orange { color: #ffb74d; } .txt-red { color: #e57373; }

/* ========== äº‹æ•…æ˜ç´° ========== */
.detail-board { background: #fffbf2; border: 1px solid #ffe0b2; border-radius: 16px; padding: 20px; margin-bottom: 20px; text-align: left; display: none; }
.detail-title { font-size: 1.1rem; font-weight: 800; color: #d35400; margin-bottom: 12px; }
.detail-item { font-size: 1rem; margin-bottom: 8px; color: #444; line-height: 1.5; font-weight: 500; }
.detail-names { color: #666; font-weight: normal; margin-left: 4px; }

/* ========== æŒ‰éˆ•èˆ‡å…¶ä»– ========== */
.control-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
.action-btn { border: none; border-radius: 14px; padding: 14px; color: white; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; position: relative; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.08); font-size: 0.95rem; }
.action-btn:active { transform: scale(0.96); }
.btn-mode { grid-column: 1 / -1; background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%); }
.btn-mode.active { background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%); }
.btn-green { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); }
.btn-red { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
.btn-blue { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); }
.btn-gray { background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); }
.report-group { display: flex; gap: 12px; margin-bottom: 25px; }
.btn-purple { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); flex: 1; }
.btn-orange { background: linear-gradient(135deg, #f39c12 0%, #d35400 100%); flex: 1; }

.roster-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; padding-bottom: 20px; }
.roster-card { background: var(--card); border-radius: 12px; min-height: 85px; padding: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
.roster-card:active { transform: scale(0.96); }
.rank-strip { position: absolute; top: 0; left: 0; right: 0; height: 4px; border-radius: 12px 12px 0 0; }
.rs-off { background: #e74c3c; } .rs-nco { background: #3498db; } .rs-sol { background: #27ae60; } .rs-tra { background: #9b59b6; }
.card-name { font-size: 1rem; font-weight: 700; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; margin-top: 4px; }
.card-name.long-text { font-size: 0.85rem; white-space: normal; line-height: 1.2; }
.st-pre { background: #f8f9fa; opacity: 0.6; } .st-pre .card-name { text-decoration: line-through; color: #aaa; }
.st-pre::after { content: 'âœ“'; position: absolute; font-size: 2rem; color: #27ae60; opacity: 0.3; }
.st-exc { background: #fffbf2; border: 1px solid #f39c12; }
.tag-exc { background: #f39c12; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-top: 4px; }
.icon-lock { position: absolute; top: 5px; right: 5px; font-size: 0.8rem; }
.time-stamp { position: absolute; bottom: 3px; right: 5px; font-size: 0.65rem; color:#999; }
.sep-row { grid-column: 1 / -1; display: flex; align-items: center; gap: 10px; margin: 15px 0 5px 0; color: #95a5a6; font-weight: 600; font-size: 0.9rem; }
.sep-line { flex: 1; height: 1px; background: #e0e0e0; }

.panel-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; opacity: 0; pointer-events: none; transition: 0.3s; }
.panel-overlay.show { opacity: 1; pointer-events: auto; }
.panel-content { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-radius: 20px 20px 0 0; padding: 25px 20px; max-height: 85vh; overflow-y: auto; transform: translateY(100%); transition: 0.3s; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); }
.panel-overlay.show .panel-content { transform: translateY(0); }
.input-group { margin-bottom: 15px; text-align: left; }
.form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; background: #fff; font-size: 1rem; }
.modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 200; backdrop-filter: blur(4px); }
.modal.show { display: flex; animation: fadeIn 0.2s; }
.modal-box { background: #fff; width: 90%; max-width: 360px; border-radius: 20px; padding: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
.modal-options { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin: 15px 0; }
.opt-btn { padding: 12px 0; border: none; border-radius: 10px; font-weight: 600; color: white; cursor: pointer; }
.toast { position: fixed; bottom: 30px; left: 50%; transform: translate(-50%, 20px); background: #333; color: white; padding: 10px 24px; border-radius: 30px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 300; }
.toast.show { opacity: 1; transform: translate(-50%, 0); }
@keyframes fadeIn { from{opacity:0} to{opacity:1} }
</style>
</head>
<body>

<div class="page-container">
    <div class="header-section">
        <div class="header-top">
            <h1 class="page-title">ğŸ“ é»åç³»çµ± <span class="ver-tag">v3.2</span></h1>
            <div class="header-actions">
                <button class="header-btn" onclick="togglePanel('setup-panel')">âš™ï¸</button>
                <button class="header-btn" onclick="togglePanel('history-panel')">ğŸ“…</button>
                <button class="header-btn" onclick="togglePanel('help-panel')">â”</button>
            </div>
        </div>

        <!-- ğŸ”¥ æ–°å¢ï¼šæ—¥æœŸèˆ‡æ™‚æ®µè³‡è¨Šæ¬„ ğŸ”¥ -->
        <div class="session-info-bar">
            <span id="current-date-display">è¼‰å…¥ä¸­...</span>
            <div id="current-period-badge" class="period-badge">--</div>
        </div>

        <input type="text" id="search-input" class="search-input" placeholder="ğŸ” è¼¸å…¥å§“åå¿«é€ŸæŸ¥æ‰¾..." oninput="filterRoster()">
    </div>

    <!-- å„€è¡¨æ¿ -->
    <div class="stats-dashboard">
        <div class="stat-card"><span class="stat-label">æ‡‰åˆ°</span><span class="stat-value" style="color:#333" id="stat-total">0</span></div>
        <div class="stat-card"><span class="stat-label">å¯¦åˆ°</span><span class="stat-value txt-green" id="stat-present">0</span></div>
        <div class="stat-card"><span class="stat-label">äº‹æ•…</span><span class="stat-value txt-orange" id="stat-excuse">0</span></div>
        <div class="stat-card" style="background:#fff5f5;border:1px solid #ffccd5"><span class="stat-label">æœªåˆ°</span><span class="stat-value txt-red" id="stat-absent">0</span></div>
    </div>

    <!-- éšç´šçµ±è¨ˆè¡¨ -->
    <div class="rank-box">
        <div class="progress-container" id="p-bar"></div>
        <table class="rank-table">
            <thead>
                <tr>
                    <th style="text-align:left;padding-left:15px">éšç´š</th>
                    <th>æ‡‰åˆ°</th>
                    <th>å¯¦åˆ°</th>
                    <th>äº‹æ•…</th>
                    <th>æœªåˆ°</th>
                </tr>
            </thead>
            <tbody id="rank-stats-body"></tbody>
        </table>
    </div>

    <!-- äº‹æ•…æ˜ç´° -->
    <div id="detail-board" class="detail-board">
        <div class="detail-title">ğŸ“Œ äº‹æ•…æ˜ç´°ï¼š</div>
        <div id="detail-tags"></div>
    </div>

    <!-- æ§åˆ¶æŒ‰éˆ• -->
    <div class="control-grid">
        <button class="action-btn btn-mode" id="mode-btn" onclick="toggleMode()">âš ï¸ äº‹æ•…æ¨¡å¼ï¼šé—œ</button>
        <button class="action-btn btn-green" onclick="markAllPresent()">âš¡ é¤˜å“¡å…¨åˆ°</button>
        <button class="action-btn btn-red" onclick="showMissing()">ğŸ“¢ æŸ¥æœªåˆ°</button>
        <button class="action-btn btn-blue" onclick="toggleSort()" id="sort-btn">ğŸ”ƒ æ’åºï¼šåŸåº</button>
        <button class="action-btn btn-gray" onclick="resetAll()">ğŸ”„ é‡ç½®ç‹€æ…‹</button>
    </div>

    <div class="report-group">
        <button class="action-btn btn-purple" onclick="copyCSMReport()">ğŸ“‹ ç‡Ÿå£«ç£å›å ±</button>
        <button class="action-btn btn-orange" onclick="copyReport()">ğŸ“‹ å€¼æ˜Ÿå›å ±</button>
    </div>

    <div id="roster" class="roster-grid"></div>
</div>

<!-- å½ˆçª—å€‘ -->
<div id="setup-panel" class="panel-overlay">
    <div class="panel-content">
        <h2>âš™ï¸ ç³»çµ±è¨­å®š</h2>
        <div class="input-group"><label>å–®ä½åç¨±</label><input type="text" id="in-unit" class="form-control" placeholder="ä¾‹å¦‚ï¼šæ­¥ä¸€é€£"></div>
        <div class="input-group"><div style="display:flex;justify-content:space-between"><strong>ğŸ›‘ è»å®˜</strong><span style="color:#3498db" onclick="insertSep('in-off')">+åˆ†çµ„</span></div><textarea id="in-off" class="form-control" style="height:60px"></textarea></div>
        <div class="input-group"><div style="display:flex;justify-content:space-between"><strong>ğŸ”· å£«å®˜</strong><span style="color:#3498db" onclick="insertSep('in-nco')">+åˆ†çµ„</span></div><textarea id="in-nco" class="form-control" style="height:60px"></textarea></div>
        <div class="input-group"><div style="display:flex;justify-content:space-between"><strong>ğŸŸ© å£«å…µ</strong><span style="color:#3498db" onclick="insertSep('in-sol')">+åˆ†çµ„</span></div><textarea id="in-sol" class="form-control" style="height:80px"></textarea></div>
        <div class="input-group"><div style="display:flex;justify-content:space-between"><strong>ğŸŸ£ è¨“å“¡</strong><span style="color:#3498db" onclick="insertSep('in-tra')">+åˆ†çµ„</span></div><textarea id="in-tra" class="form-control" style="height:60px"></textarea></div>
        <div class="input-group"><label>è‡ªè¨‚äº‹æ•…</label><input type="text" id="in-reasons" class="form-control" placeholder="é€—è™Ÿåˆ†éš”"></div>
        <button class="action-btn btn-green" style="width:100%;margin-bottom:12px" onclick="saveData()">âœ… å„²å­˜</button>
        <div style="display:flex;gap:10px"><button class="action-btn btn-gray" style="flex:1" onclick="exportData()">ğŸ“¤ å‚™ä»½</button><button class="action-btn btn-gray" style="flex:1" onclick="importData()">ğŸ“¥ è®€å–</button></div>
        <button class="action-btn" style="width:100%;background:transparent;color:#999;margin-top:10px;box-shadow:none" onclick="togglePanel('setup-panel')">é—œé–‰</button>
    </div>
</div>

<div id="history-panel" class="panel-overlay">
    <div class="panel-content">
        <h2>ğŸ“… æ­·å²ç´€éŒ„ (<span id="history-count">0</span>)</h2>
        <div style="background:white;padding:15px;border-radius:12px;margin-bottom:15px;border:1px solid #eee">
            <input type="date" id="history-date" class="form-control" style="margin-bottom:10px">
            <select id="history-period" class="form-control" style="margin-bottom:10px"><option value="am">â˜€ï¸ ä¸Šåˆ</option><option value="pm">â›… ä¸‹åˆ</option><option value="night">ğŸŒ™ å¤œé–“</option></select>
            <div style="display:flex;gap:10px"><button class="action-btn btn-green" style="flex:1" onclick="saveToDate()">ğŸ“¥ å­˜æª”</button><button class="action-btn btn-blue" style="flex:1" onclick="loadFromDate()">ğŸ“¤ è®€å–</button></div>
        </div>
        <button class="action-btn btn-gray" style="width:100%;margin-bottom:10px" onclick="showHistoryList()">ğŸ“œ æ¸…å–®</button>
        <button class="action-btn btn-red" style="width:100%" onclick="clearHistory()">ğŸ—‘ï¸ æ¸…ç©º</button>
        <button class="action-btn" style="width:100%;background:transparent;color:#999;margin-top:10px;box-shadow:none" onclick="togglePanel('history-panel')">é—œé–‰</button>
    </div>
</div>

<div id="help-panel" class="panel-overlay">
    <div class="panel-content">
        <h2>ğŸ“– èªªæ˜</h2>
        <div style="text-align:left;line-height:1.6;color:#555">
            <p>1. å³ä¸Šè§’âš™ï¸è¨­å®šåå–®ã€‚</p>
            <p>2. é»å¡ç‰‡åˆ‡æ›ç‹€æ…‹ã€‚</p>
            <p>3. æ”¯æ´21/24æ”¶å‡è‡ªå‹•åˆ†é¡ã€‚</p>
        </div>
        <button class="action-btn btn-gray" style="width:100%;margin-top:20px" onclick="togglePanel('help-panel')">é—œé–‰</button>
    </div>
</div>

<div id="modal" class="modal">
    <div class="modal-box">
        <h3 id="m-name" style="margin:0 0 15px 0;text-align:center"></h3>
        <input type="text" id="note-input" class="form-control" placeholder="å‚™è¨»..." style="margin-bottom:10px">
        <div style="display:flex;gap:8px;margin-bottom:15px"><input id="custom-r" type="text" class="form-control" placeholder="è‡ªè¨‚"><button onclick="subCus()" style="width:60px;border:none;background:#3498db;color:white;border-radius:10px">OK</button></div>
        <div class="modal-options" id="opts-container"></div>
        <label style="display:flex;align-items:center;gap:8px;justify-content:center;margin:15px 0"><input type="checkbox" id="lock-status" style="transform:scale(1.3)"><span>ğŸ”’ é–å®š</span></label>
        <button class="action-btn btn-gray" style="width:100%" onclick="closeM()">å–æ¶ˆ</button>
    </div>
</div>

<div id="his-list-modal" class="modal" style="z-index:250">
    <div class="modal-box" style="max-height:80vh;display:flex;flex-direction:column">
        <h3 style="margin-top:0">ğŸ“œ æ¸…å–®</h3>
        <div id="his-items-container" style="overflow-y:auto;flex:1;margin-bottom:15px;border:1px solid #eee;border-radius:10px"></div>
        <button class="action-btn btn-gray" style="width:100%" onclick="closeHisList()">é—œé–‰</button>
    </div>
</div>
<div id="toast" class="toast"></div>

<script>
const K_CUR='army_v3_cur',K_HIS='army_v3_his';
let D={o:[],n:[],s:[],t:[],st:{},nt:{},lck:{},tm:{},u:'',rs:''},isM=false,isSorted=false,cur='';
const DEFAULT_REASONS = "ä¼‘å‡,å¤–å®¿,è£œä¼‘,è¡›å“¨,å®‰å®˜,æˆ°æƒ…,å…¬å·®,å—è¨“,æ”¯æ´,è½‰è¨º,ä½é™¢,éš”é›¢";

document.addEventListener('DOMContentLoaded',()=>{
    document.getElementById('history-date').valueAsDate=new Date();
    load(); updateHisCount(); updateDateTime();
});

// ğŸ”¥ æ–°å¢ï¼šæ—¥æœŸèˆ‡æ™‚æ®µæ›´æ–°é‚è¼¯ ğŸ”¥
function updateDateTime() {
    const now = new Date();
    const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
    
    // æ—¥æœŸæ ¼å¼: 10/24 (é€±äºŒ)
    const dateStr = `${now.getMonth()+1}/${now.getDate()} (é€±${days[now.getDay()]})`;
    document.getElementById('current-date-display').innerText = dateStr;

    // æ™‚æ®µåˆ¤æ–·
    const hour = now.getHours();
    let periodText = '';
    let periodClass = '';

    if (hour < 12) {
        periodText = 'â˜€ï¸ ä¸Šåˆ';
        periodClass = 'p-am';
    } else if (hour < 18) {
        periodText = 'â›… ä¸‹åˆ';
        periodClass = 'p-pm';
    } else {
        periodText = 'ğŸŒ™ å¤œé–“';
        periodClass = 'p-night';
    }

    const badge = document.getElementById('current-period-badge');
    badge.innerText = periodText;
    // ç§»é™¤èˆŠçš„ classï¼ŒåŠ ä¸Šæ–°çš„
    badge.className = `period-badge ${periodClass}`;
}

function showToast(msg) {
    const t = document.getElementById('toast');
    t.innerText = msg; t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), 2000);
}
function togglePanel(id) {
    const p = document.getElementById(id);
    if(p.classList.contains('show')) p.classList.remove('show');
    else {
        document.querySelectorAll('.panel-overlay').forEach(e=>e.classList.remove('show'));
        p.classList.add('show');
        if(id==='history-panel') updateHisCount();
    }
}
function insertSep(id){
    const name = prompt("è¼¸å…¥åˆ†çµ„åç¨±:");
    if(name){
        const el = document.getElementById(id);
        const txt = ` ---${name}--- `;
        el.value = el.value.slice(0, el.selectionStart) + txt + el.value.slice(el.selectionEnd);
        saveData();
    }
}

function saveData(){
    D.u=document.getElementById('in-unit').value.trim();
    D.rs=document.getElementById('in-reasons').value.trim();
    D.o=parse(document.getElementById('in-off').value);D.n=parse(document.getElementById('in-nco').value);D.s=parse(document.getElementById('in-sol').value);D.t=parse(document.getElementById('in-tra').value);
    persist();render();togglePanel('setup-panel');showToast("âœ… å·²å„²å­˜");
}
function persist(){localStorage.setItem(K_CUR,JSON.stringify(D))}
function parse(t){return t?t.split(/[\s,ã€\n]+/).filter(x=>x.trim()):[]}
function load(){
    const r=localStorage.getItem(K_CUR);
    if(r){D=JSON.parse(r);fillSetup();render()}else{togglePanel('setup-panel')}
}
function fillSetup(){
    document.getElementById('in-unit').value=D.u||'';
    document.getElementById('in-reasons').value=D.rs||DEFAULT_REASONS;
    document.getElementById('in-off').value=D.o.join(' ');document.getElementById('in-nco').value=D.n.join(' ');document.getElementById('in-sol').value=D.s.join(' ');document.getElementById('in-tra').value=D.t.join(' ');
}

function toggleMode(){ isM=!isM; document.getElementById('mode-btn').innerText=isM?"âš ï¸ äº‹æ•…æ¨¡å¼ï¼šé–‹":"âš ï¸ äº‹æ•…æ¨¡å¼ï¼šé—œ"; document.getElementById('mode-btn').classList.toggle('active', isM); }
function toggleSort(){ isSorted=!isSorted; document.getElementById('sort-btn').innerText=isSorted?"ğŸ”ƒ æ’åºï¼šæœªåˆ°å„ªå…ˆ":"ğŸ”ƒ æ’åºï¼šåŸåº"; render(); }
function filterRoster(){ const k=document.getElementById('search-input').value.toLowerCase(); document.querySelectorAll('.roster-card').forEach(c=>c.style.display=c.innerText.toLowerCase().includes(k)?'flex':'none'); }

function markAllPresent(){
    if(confirm("å°‡æ‰€æœ‰æœªé»åè€…è¨­ç‚ºã€Œå¯¦åˆ°ã€ï¼Ÿ")){
        const t = new Date().toTimeString().slice(0,5);
        [...D.o,...D.n,...D.s,...D.t].forEach(n=>{ if(!D.st[n] && !n.startsWith('-')){ D.st[n]='p'; D.tm[n]=t; }});
        persist();render();showToast("âš¡ å…¨è¨­å¯¦åˆ°");
    }
}
function resetAll(){
    if(confirm("é‡ç½®æ‰€æœ‰ç‹€æ…‹ï¼Ÿ")){
        [...D.o,...D.n,...D.s,...D.t].forEach(n=>{ if(!D.lck||!D.lck[n]){ delete D.st[n]; delete D.nt[n]; delete D.tm[n]; }});
        persist();render();showToast("ğŸ”„ å·²é‡ç½®");
    }
}

function render(){
    const c=document.getElementById('roster'); c.innerHTML='';
    const groups = [{l:D.o,c:'rs-off'},{l:D.n,c:'rs-nco'},{l:D.s,c:'rs-sol'},{l:D.t,c:'rs-tra'}];
    let items = [];
    if(isSorted){
        groups.forEach(g=>g.l.forEach(n=>{if(!n.startsWith('-')&&!n.startsWith('#'))items.push({n,t:g.c})}));
        items.sort((a,b)=>{ const sc=(nm)=>!D.st[nm]?0:(D.st[nm]!=='p'?1:2); return sc(a.n)-sc(b.n) });
    }
    const mkCard = (n,cls) => {
        if(n.startsWith('-')||n.startsWith('#')){
            const d=document.createElement('div'); d.className='sep-row'; d.innerHTML=`<div class="sep-line"></div>${n.replace(/[-#]/g,'').trim()}<div class="sep-line"></div>`; return d;
        }
        const card = document.createElement('div');
        const st = D.st[n];
        card.className = `roster-card ${st==='p'?'st-pre':(st?'st-exc':'')}`;
        
        let sub='', name=n, m=n.match(/^(.*?)[ï¼ˆ\(](.*)[ï¼‰\)]$/);
        if(m){ name=m[1]; sub=m[2]; }
        let nameClass = 'card-name';
        if(name.length >= 6) nameClass += ' super-long-text'; else if(name.length >= 4) nameClass += ' long-text';

        let h = `<div class="rank-strip ${cls}"></div><div class="${nameClass}">${name}</div>`;
        if(sub) h += `<div class="card-sub">${sub}</div>`;
        
        if(st && st!=='p') {
             let bg = '#f39c12';
             if(['è½‰è¨º','ä½é™¢','éš”é›¢'].some(k=>st.includes(k))) bg='#e74c3c';
             else if(['å…¬å·®','å—è¨“','æ”¯æ´'].some(k=>st.includes(k))) bg='#3498db';
             else if(['è¡›å“¨','å®‰å®˜','æˆ°æƒ…'].some(k=>st.includes(k))) bg='#27ae60';
             h += `<div class="tag-exc" style="background:${bg}">${st}</div>`;
        }
        if(D.nt && D.nt[n]) h += `<div class="card-sub" style="color:#2980b9">ğŸ“${D.nt[n]}</div>`;
        if(D.lck && D.lck[n]) h += `<div class="icon-lock">ğŸ”’</div>`;
        if(D.tm && D.tm[n] && st==='p') h += `<div class="time-stamp">${D.tm[n]}</div>`;

        card.innerHTML = h;
        card.onclick = () => cardClick(n, name);
        return card;
    };
    if(isSorted) items.forEach(i=>c.appendChild(mkCard(i.n,i.t)));
    else groups.forEach(g=>g.l.forEach(n=>c.appendChild(mkCard(n,g.c))));
    updateStats(); filterRoster();
}

function cardClick(n, name){
    if(navigator.vibrate) navigator.vibrate(10);
    if(isM){
        cur=n; document.getElementById('m-name').innerText=name;
        document.getElementById('custom-r').value='';
        document.getElementById('note-input').value=D.nt[n]||'';
        document.getElementById('lock-status').checked=!!D.lck[n];
        renderOpts(); document.getElementById('modal').classList.add('show');
    } else {
        if(D.lck[n]) return showToast("ğŸ”’ æ­¤äººå“¡å·²é–å®š");
        if(D.st[n]==='p') { delete D.st[n]; delete D.tm[n]; }
        else { D.st[n]='p'; D.tm[n]=new Date().toTimeString().slice(0,5); }
        persist(); render();
    }
}
function renderOpts(){
    const c=document.getElementById('opts-container'); c.innerHTML='';
    const rs=(D.rs||DEFAULT_REASONS).split(/[,ï¼Œ]/);
    rs.forEach(r=>{
        if(!r.trim())return;
        const b=document.createElement('button'); b.className='opt-btn'; b.innerText=r;
        let bg='#9b59b6';
        if(['è½‰è¨º','ä½é™¢','éš”é›¢','ç™¼ç‡’'].some(k=>r.includes(k))) bg='#e74c3c';
        else if(['å…¬å·®','å—è¨“','æ”¯æ´'].some(k=>r.includes(k))) bg='#3498db';
        else if(['è¡›å“¨','å®‰å®˜','æˆ°æƒ…'].some(k=>r.includes(k))) bg='#27ae60';
        else if(['ä¼‘å‡','å¤–å®¿','è£œä¼‘'].some(k=>r.includes(k))) bg='#f39c12';
        b.style.background=bg; b.onclick=()=>setSt(r); c.appendChild(b);
    });
    const clr=document.createElement('button'); clr.className='opt-btn'; clr.innerText='æ¸…é™¤ç‹€æ…‹';
    clr.style.background='#95a5a6'; clr.style.gridColumn='1/-1'; clr.onclick=()=>setSt(null);
    c.appendChild(clr);
}
function subCus(){ const v=document.getElementById('custom-r').value.trim(); if(v) setSt(v); }
function setSt(v){
    D.st[cur]=v; const n=document.getElementById('note-input').value.trim();
    if(n)D.nt[cur]=n; else delete D.nt[cur];
    if(document.getElementById('lock-status').checked)D.lck[cur]=true; else delete D.lck[cur];
    if(v==='p'||!v) delete D.tm[cur];
    closeM(); persist(); render();
}
function closeM(){ document.getElementById('modal').classList.remove('show'); }

function calculateStats(){
    const calc=(l)=>l.filter(n=>!n.startsWith('-')&&!n.startsWith('#')).reduce((a,n)=>{
        a.t++; const s=D.st[n];
        if(s==='p')a.p++; else if(s){ a.e++; if(!a.dt[s])a.dt[s]=[]; a.dt[s].push(n); }
        return a;
    },{t:0,p:0,e:0,dt:{}});
    const Ro=calc(D.o), Rn=calc(D.n), Rs=calc(D.s), Rt=calc(D.t);
    const T={t:Ro.t+Rn.t+Rs.t+Rt.t, p:Ro.p+Rn.p+Rs.p+Rt.p, e:Ro.e+Rn.e+Rs.e+Rt.e};
    const Abs=T.t-T.p-T.e;
    const mergedDt={};
    [Ro,Rn,Rs,Rt].forEach(r=>{ for(let[k,a]of Object.entries(r.dt)){ if(!mergedDt[k])mergedDt[k]=[]; mergedDt[k].push(...a); }});
    return {Ro, Rn, Rs, Rt, T, Abs, mergedDt};
}

function updateStats(){
    const S = calculateStats();
    document.getElementById('stat-total').innerText=S.T.t; document.getElementById('stat-present').innerText=S.T.p;
    document.getElementById('stat-excuse').innerText=S.T.e; document.getElementById('stat-absent').innerText=S.Abs;
    
    // æ›´æ–°è¡¨æ ¼ (å¹¾ä½•åœ–å½¢åœ–ç¤º)
    const row = (name, d, iconClass) => `
        <tr>
            <td style="text-align:left;padding-left:15px">
                <span class="icon-shape ${iconClass}"></span>${name}
            </td>
            <td>${d.t}</td>
            <td class="txt-green">${d.p}</td>
            <td class="txt-orange">${d.e}</td>
            <td class="txt-red">${d.t-d.p-d.e}</td>
        </tr>`;

    document.getElementById('rank-stats-body').innerHTML = 
        row('è»å®˜', S.Ro, 'shape-off') + 
        row('å£«å®˜', S.Rn, 'shape-nco') + 
        row('å£«å…µ', S.Rs, 'shape-sol') + 
        row('è¨“å“¡', S.Rt, 'shape-tra');
    
    if(S.T.t>0) document.getElementById('p-bar').innerHTML = `<div class="pb-seg" style="width:${(S.T.p/S.T.t)*100}%;background:#4caf50"></div><div class="pb-seg" style="width:${(S.T.e/S.T.t)*100}%;background:#ffb74d"></div><div class="pb-seg" style="width:${(S.Abs/S.T.t)*100}%;background:#e57373"></div>`;
    
    // äº‹æ•…æ˜ç´° (ç¬¦åˆæˆªåœ–æ ¼å¼)
    const db=document.getElementById('detail-board'), dt=document.getElementById('detail-tags');
    dt.innerHTML='';
    if(S.T.e>0){
        db.style.display='block';
        for(let[k,arr]of Object.entries(S.mergedDt)){
            const ns = arr.map(x => x.split(/[ï¼ˆ\(]/)[0] + (D.nt[x] ? `[${D.nt[x]}]` : '')).join(' ');
            dt.innerHTML += `<div class="detail-item">${k} (${arr.length}): <span class="detail-names">${ns}</span></div>`;
        }
    } else db.style.display='none';
}

async function copyText(txt) {
    try { await navigator.clipboard.writeText(txt); showToast("âœ… è¤‡è£½æˆåŠŸ"); } 
    catch {
        const ta = document.createElement("textarea"); ta.value = txt; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
        showToast("âœ… è¤‡è£½æˆåŠŸ (å…¼å®¹æ¨¡å¼)");
    }
}

function copyReport(){
    const S = calculateStats();
    if(S.Abs>0) return alert("âš ï¸ é‚„æœ‰æœªåˆ°äººå“¡ï¼");
    let now=new Date();
    let r=`ã€éƒ¨éšŠé»åå›å ±ã€‘\nå–®ä½ï¼š${D.u||''}\næ™‚é–“ï¼š${now.getMonth()+1}/${now.getDate()} ${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}\n`;
    r+=`æ‡‰åˆ°ï¼š${S.T.t} (å®˜${S.Ro.t}å£«${S.Rn.t}å…µ${S.Rs.t}è¨“${S.Rt.t})\nå¯¦åˆ°ï¼š${S.T.p} (å®˜${S.Ro.p}å£«${S.Rn.p}å…µ${S.Rs.p}è¨“${S.Rt.p})\näº‹æ•…ï¼š${S.T.e} (å®˜${S.Ro.e}å£«${S.Rn.e}å…µ${S.Rs.e}è¨“${S.Rt.e})\næœªåˆ°ï¼š${S.Abs}\n----------------\n`;
    if(S.T.e>0){
        for(let[k,arr]of Object.entries(S.mergedDt)){
            const ns=arr.map(x=>x.split(/[ï¼ˆ\(]/)[0]+(D.nt[x]?`[${D.nt[x].replace(/2[14]æ”¶|07æ”¶/g,'')}]`:'')).join(' ');
            r+=`${k}ï¼š${arr.length}å“¡ (${ns})\n`;
        }
    } else r+="ç„¡äº‹æ•…äººå“¡\n";
    copyText(r);
}

function copyCSMReport(){
    const S = calculateStats();
    if(S.Abs>0) return alert("âš ï¸ é‚„æœ‰æœªåˆ°äººå“¡ï¼");
    let now=new Date();
    let r=`ç‡Ÿå£«ç£å¥½\n\n${D.u||''}å›å ±ï¼ˆ${now.getMonth()+1}/${now.getDate()}ï¼‰æ”¶å‡\n`;
    r+=`æ‡‰åˆ°ï¼š${S.Ro.t}å®˜${S.Rn.t}å£«${S.Rs.t}å…µ${S.Rt.t}è¨“\n`;
    r+=`å¯¦åˆ°ï¼š${S.Ro.p}å®˜${S.Rn.p}å£«${S.Rs.p}å…µ${S.Rt.p}è¨“\n`;
    
    const all = [...D.o,...D.n,...D.s,...D.t];
    const r21=[], r24=[], r07=[];
    all.forEach(n=>{
        const note = (D.nt[n]||'').toLowerCase();
        if(note.includes('21æ”¶')) r21.push(n);
        else if(note.includes('24æ”¶')) r24.push(n);
        else if(note.includes('07æ”¶')) r07.push(n);
    });
    
    const fmtList = (list) => {
        if(list.length===0) return "ç„¡";
        const f = list[0].split(/[ï¼ˆ\(]/)[0];
        return `${f}ç­‰${list.length}å“¡\n${list.map(x=>x.split(/[ï¼ˆ\(]/)[0]).join('\n')}`;
    }
    
    r+=`ï¼ˆ${S.T.p>0 ? 'äººå“¡åˆ°é½Š' : 'ç„¡'}ï¼‰\n\n`;
    r+=`21æ”¶å‡ï¼š${fmtList(r21)}\n24æ”¶å‡ï¼š${fmtList(r24)}\n07æ”¶å‡ï¼š${fmtList(r07)}\näº‹æ•…ï¼š\n`;
    
    const returners = [...r21, ...r24, ...r07];
    let accCount = 0;
    for(let[k,arr]of Object.entries(S.mergedDt)){
        const realAcc = arr.filter(n => !returners.includes(n));
        if(realAcc.length > 0){
            accCount++;
            const ns = realAcc.map(x=>x.split(/[ï¼ˆ\(]/)[0]+(D.nt[x]?`[${D.nt[x].replace(/2[14]æ”¶|07æ”¶/g,'')}]`:'')).join('\n');
            r+=`${k}ï¼š\n${ns}\n`;
        }
    }
    if(accCount===0) r+="ç„¡äº‹æ•…äººå“¡\n";
    copyText(r);
}

function exportData(){ const d=JSON.stringify({cur:JSON.parse(localStorage.getItem(K_CUR)||'{}'),his:JSON.parse(localStorage.getItem(K_HIS)||'{}')}); copyText(d); }
function importData(){ const s=prompt("è²¼ä¸Šå‚™ä»½ç¢¼:"); if(s){try{const d=JSON.parse(s);localStorage.setItem(K_CUR,JSON.stringify(d.cur));localStorage.setItem(K_HIS,JSON.stringify(d.his));location.reload()}catch{alert("æ ¼å¼éŒ¯èª¤")}} }
function getHis(){return JSON.parse(localStorage.getItem(K_HIS)||'{}')}
function updateHisCount(){document.getElementById('history-count').innerText=Object.keys(getHis()).length}
function saveToDate(){ const d=document.getElementById('history-date').value; if(!d)return alert("é¸æ—¥æœŸ"); const k=`${d}_${document.getElementById('history-period').value}`; const h=getHis(); h[k]=D; localStorage.setItem(K_HIS,JSON.stringify(h)); updateHisCount(); showToast("âœ… å·²å­˜æª”"); }
function loadFromDate(){ const k=`${document.getElementById('history-date').value}_${document.getElementById('history-period').value}`; const h=getHis(); if(h[k]){ D=h[k]; persist(); render(); togglePanel('history-panel'); showToast("âœ… è®€å–æˆåŠŸ"); } else alert("æŸ¥ç„¡ç´€éŒ„"); }
function showHistoryList(){ const h=getHis(),c=document.getElementById('his-items-container');c.innerHTML=''; Object.keys(h).sort().reverse().forEach(k=>{ const d=document.createElement('div'); d.style.cssText='padding:12px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center'; d.innerHTML=`<span>${k}</span> <button style="border:none;background:#e74c3c;color:white;padding:5px 10px;border-radius:5px;cursor:pointer" onclick="delHis('${k}')">åˆª</button>`; c.appendChild(d); }); document.getElementById('his-list-modal').classList.add('show'); }
function delHis(k){if(confirm("åˆªé™¤?")){const h=getHis();delete h[k];localStorage.setItem(K_HIS,JSON.stringify(h));showHistoryList();updateHisCount();}}
function closeHisList(){document.getElementById('his-list-modal').classList.remove('show')}
function clearHistory(){if(confirm("æ¸…ç©º?")){localStorage.removeItem(K_HIS);updateHisCount();showToast("å·²æ¸…ç©º")}}
</script>
</body>
</html>
