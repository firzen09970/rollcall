<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>éƒ¨éšŠé»åç³»çµ± v3.5 (äº‹æ•…åŠŸèƒ½ä¿®å¾©)</title>
<style>
:root{
  --bg: #f5f7fa;
  --card: #ffffff;
  --text: #1f2937;
  --primary: #2563eb;
  --nav-height: 65px;
  --safe-area-bottom: env(safe-area-inset-bottom);
}
*{box-sizing:border-box}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  background:var(--bg); color:var(--text); margin:0; padding:0;
  text-align:center; user-select:none; -webkit-tap-highlight-color:transparent;
  padding-bottom: calc(var(--nav-height) + var(--safe-area-bottom) + 20px);
  overflow-y: scroll;
}

/* ========== å…±ç”¨æ¨£å¼ ========== */
.page-view { display: none; padding: 15px; max-width: 600px; margin: 0 auto; animation: fadeIn 0.3s; }
.page-view.active { display: block; }
@keyframes fadeIn { from{opacity:0; transform:translateY(5px)} to{opacity:1; transform:translateY(0)} }

.card-box { background: var(--card); border-radius: 16px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 12px; }
.section-title { font-size: 1.1rem; font-weight: 800; text-align: left; margin-bottom: 12px; display: flex; align-items: center; gap:8px; color: #374151; }

.btn { border: none; border-radius: 12px; padding: 12px; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; width: 100%; }
.btn:active { transform: scale(0.97); filter: brightness(0.95); }
.btn-blue { background: #eff6ff; color: #2563eb; border: 1px solid #dbeafe; }
.btn-green { background: #ecfdf5; color: #059669; border: 1px solid #d1fae5; }
.btn-red { background: #fef2f2; color: #dc2626; border: 1px solid #fee2e2; }
.btn-org { background: #fff7ed; color: #ea580c; border: 1px solid #ffedd5; }
.btn-dark { background: #374151; color: white; }

/* äº‹æ•…æ¨¡å¼é–‹å•Ÿæ™‚çš„æŒ‰éˆ•ç‹€æ…‹ */
.btn-org.active { background: #ea580c; color: white; box-shadow: 0 4px 10px rgba(234, 88, 12, 0.3); border-color: #ea580c; }

/* åº•éƒ¨å°è¦½åˆ— */
.bottom-nav {
    position: fixed; bottom: 0; left: 0; right: 0; height: calc(var(--nav-height) + var(--safe-area-bottom));
    background: #ffffff; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-around;
    padding-bottom: var(--safe-area-bottom); z-index: 1000; box-shadow: 0 -4px 20px rgba(0,0,0,0.03);
}
.nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #9ca3af; font-size: 0.75rem; gap: 4px; cursor: pointer; }
.nav-icon { font-size: 1.4rem; margin-bottom: 2px; transition: 0.2s; }
.nav-item.active { color: var(--primary); font-weight: 600; }
.nav-item.active .nav-icon { transform: translateY(-2px); }

/* ç¸½è¦½é  */
.hero-header { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border-radius: 20px; padding: 20px; text-align: left; margin-bottom: 15px; box-shadow: 0 10px 25px -5px rgba(37, 99, 235, 0.4); }
.time-big { font-size: 1.8rem; font-weight: 800; letter-spacing: 1px; }
.stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
.stat-box { background: white; padding: 15px; border-radius: 16px; text-align: center; border: 1px solid #f3f4f6; }
.sb-val { font-size: 1.8rem; font-weight: 800; line-height: 1; }
.rank-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
.rank-table th { text-align: left; color: #9ca3af; padding: 8px 4px; font-weight: 500; font-size: 0.85rem; }
.rank-table td { padding: 12px 4px; font-weight: 600; border-bottom: 1px solid #f3f4f6; }

/* é»åé  */
.sticky-top-bar { position: sticky; top: 0; z-index: 90; background: var(--bg); margin: -15px -15px 10px -15px; padding: 15px 15px 5px 15px; backdrop-filter: blur(8px); border-bottom: 1px solid rgba(0,0,0,0.05); }
.mini-stats { display: flex; justify-content: space-between; align-items: center; background: #1f2937; color: white; padding: 10px 16px; border-radius: 12px; margin-bottom: 10px; font-size: 0.95rem; font-weight: 600; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

/* æ§åˆ¶æŒ‰éˆ•å€ */
.control-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }

.filter-tabs { display: flex; gap: 8px; margin-bottom: 10px; overflow-x: auto; padding-bottom: 5px; -webkit-overflow-scrolling: touch; }
.ft-btn { white-space: nowrap; padding: 8px 16px; border-radius: 20px; background: #e5e7eb; color: #4b5563; font-size: 0.9rem; font-weight: 600; border: none; }
.ft-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3); }

.search-input { width: 100%; padding: 10px 12px; border: none; background: white; border-radius: 12px; font-size: 1rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); margin-bottom: 10px; }

.roster-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
.r-card { background: white; border-radius: 12px; padding: 10px 4px; min-height: 75px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); position: relative; cursor: pointer; border: 2px solid transparent; transition: 0.1s; user-select: none; }
.r-card:active { transform: scale(0.96); background: #f9fafb; }
.rc-name { font-size: 1.05rem; font-weight: 700; color: #111827; margin-bottom: 2px; text-align: center; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.rc-name.long { font-size: 0.85rem; white-space: normal; line-height: 1.2; overflow: visible; }
.rc-sub { font-size: 0.75rem; color: #9ca3af; }
.rc-badge { position: absolute; top: -6px; right: -6px; padding: 2px 6px; border-radius: 8px; font-size: 0.7rem; color: white; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.rc-lock { position: absolute; top: 4px; left: 4px; font-size: 0.7rem; opacity: 0.5; }

/* ç‹€æ…‹é¡è‰² */
.st-p { border-color: #10b981; background: #ecfdf5; } .st-p .rc-name { color: #059669; }
.st-e { border-color: #f59e0b; background: #fffbeb; }
.bg-red { background: #ef4444; } .bg-blue { background: #3b82f6; } .bg-org { background: #f59e0b; } .bg-green { background: #10b981; }
.sep-row { grid-column: 1 / -1; font-size: 0.85rem; color: #9ca3af; margin: 15px 0 5px 0; display: flex; align-items: center; gap: 10px; font-weight:bold; }
.sep-line { flex: 1; height: 1px; background: #e5e7eb; }

/* è¨­å®šé å„ªåŒ– */
.setup-tabs { display: flex; background: #e5e7eb; padding: 4px; border-radius: 12px; margin-bottom: 15px; overflow-x: auto; }
.st-tab { flex: 1; text-align: center; padding: 8px 4px; font-size: 0.9rem; color: #6b7280; border-radius: 8px; cursor: pointer; white-space: nowrap; font-weight: 600; }
.st-tab.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
.setup-editor { display: none; }
.setup-editor.active { display: block; animation: fadeIn 0.2s; }
.setup-textarea { width: 100%; height: 200px; padding: 15px; border: 1px solid #d1d5db; border-radius: 12px; font-size: 1rem; line-height: 1.6; resize: none; background: #f9fafb; font-family: monospace; }
.tool-btn { font-size: 0.8rem; padding: 6px 12px; background: #eff6ff; color: #2563eb; border-radius: 20px; font-weight: 600; border: none; cursor: pointer; margin-bottom: 10px; float: right; }
.form-control { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 1rem; background: white; }

/* å½ˆçª— */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 2000; display: none; backdrop-filter: blur(3px); align-items: center; justify-content: center; }
.modal-overlay.show { display: flex; animation: fadeIn 0.2s; }
.modal-box { background: white; width: 90%; max-width: 340px; border-radius: 20px; padding: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
.opt-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin: 15px 0; }
.toast { position: fixed; bottom: 80px; left: 50%; transform: translate(-50%, 20px); background: #1f2937; color: white; padding: 10px 24px; border-radius: 30px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 3000; font-size: 0.95rem; font-weight: 600; width: max-content; }
.toast.show { opacity: 1; transform: translate(-50%, 0); }
</style>
</head>
<body>

<!-- 1. ç¸½è¦½é  -->
<div id="view-home" class="page-view active">
    <div class="hero-header">
        <div id="dash-date" style="font-size:0.9rem; opacity:0.9; margin-bottom:4px">è¼‰å…¥ä¸­...</div>
        <div id="dash-time" class="time-big">--:--</div>
        <div id="dash-unit" style="margin-top:8px; font-size:0.9rem; opacity:0.8">æœªè¨­å®šå–®ä½</div>
    </div>

    <div class="stats-grid">
        <div class="stat-box">
            <div style="font-size:0.85rem; color:#6b7280; margin-bottom:5px">å¯¦åˆ°äººæ•¸</div>
            <div class="sb-val" style="color:#059669" id="d-pres">0</div>
        </div>
        <div class="stat-box">
            <div style="font-size:0.85rem; color:#6b7280; margin-bottom:5px">æœªåˆ°äººæ•¸</div>
            <div class="sb-val" style="color:#dc2626" id="d-abs">0</div>
        </div>
    </div>

    <button class="btn btn-green" style="margin-bottom:15px" onclick="markSmart()">âš¡ é¤˜å“¡å…¨åˆ° (å¿«é€Ÿ)</button>

    <div class="card-box">
        <div class="section-title">ğŸ“Š éšç´šçµ±è¨ˆ</div>
        <table class="rank-table">
            <thead><tr><th>éšç´š</th><th>æ‡‰åˆ°</th><th>å¯¦åˆ°</th><th>äº‹æ•…</th><th>æœªåˆ°</th></tr></thead>
            <tbody id="rank-tbody"></tbody>
        </table>
    </div>

    <div class="card-box" id="detail-box" style="display:none">
        <div class="section-title">ğŸ“Œ äº‹æ•…æ˜ç´°</div>
        <div id="detail-content" style="text-align:left; font-size:0.95rem; line-height:1.6; color:#4b5563;"></div>
    </div>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
        <button class="btn btn-blue" onclick="copyReport(false)">ğŸ“‹ å€¼æ˜Ÿå›å ±</button>
        <button class="btn btn-blue" onclick="copyReport(true)">ğŸ“‹ ç‡Ÿå£«ç£å›å ±</button>
    </div>
    <button class="btn btn-red" style="margin-top:15px" onclick="resetAll()">ğŸ”„ å…¨éƒ¨é‡ç½® (æ–°çš„ä¸€å¤©)</button>
</div>

<!-- 2. é»åé  -->
<div id="view-roster" class="page-view">
    <div class="sticky-top-bar">
        <div class="mini-stats">
            <span id="mini-status-text">é»åä¸­...</span>
            <span>å¯¦åˆ° <span id="r-pres" style="color:#34d399;font-size:1.1rem">0</span> / <span id="r-tot">0</span></span>
        </div>
        
        <input type="text" id="search-input" class="search-input" placeholder="ğŸ” æœå°‹..." oninput="renderRoster()">

        <div class="control-row">
            <!-- æ¢å¾©é€™å€‹æŒ‰éˆ•ï¼šäº‹æ•…æ¨¡å¼ -->
            <button id="mode-btn" class="btn btn-org" onclick="toggleMode()">âš ï¸ ä¸€èˆ¬æ¨¡å¼</button>
            <button class="btn btn-green" onclick="markSmart()">âš¡ é¤˜å“¡å…¨åˆ°</button>
        </div>

        <div class="filter-tabs">
            <button class="ft-btn active" onclick="setFilter('all', this)">å…¨éƒ¨</button>
            <button class="ft-btn" onclick="setFilter('off', this)">è»å®˜</button>
            <button class="ft-btn" onclick="setFilter('nco', this)">å£«å®˜</button>
            <button class="ft-btn" onclick="setFilter('sol', this)">å£«å…µ</button>
            <button class="ft-btn" onclick="setFilter('tra', this)">è¨“å“¡</button>
        </div>
        <div style="font-size:0.75rem; color:#6b7280; text-align:center; padding-bottom:5px">
            æç¤ºï¼šé»æ“Šè®Šå¯¦åˆ°ï¼Œé–‹å•Ÿäº‹æ•…æ¨¡å¼(æˆ–é•·æŒ‰)å¯é¸äº‹æ•…
        </div>
    </div>

    <div id="roster-grid" class="roster-grid"></div>
    <div style="height:50px"></div>
</div>

<!-- 3. ç´€éŒ„é  -->
<div id="view-history" class="page-view">
    <div class="section-title">ğŸ“… æ­·å²ç´€éŒ„</div>
    <div class="card-box">
        <input type="date" id="his-date" class="form-control" style="margin-bottom:10px">
        <select id="his-period" class="form-control" style="margin-bottom:10px">
            <option value="am">â˜€ï¸ ä¸Šåˆ</option>
            <option value="pm">â›… ä¸‹åˆ</option>
            <option value="night">ğŸŒ™ å¤œé–“</option>
        </select>
        <div style="display:flex; gap:10px">
            <button class="btn btn-green" onclick="saveHis()">ğŸ“¥ å­˜æª”</button>
            <button class="btn btn-blue" onclick="loadHis()">ğŸ“¤ è®€å–</button>
        </div>
    </div>
    <div id="his-list" style="display:flex; flex-direction:column; gap:8px;"></div>
</div>

<!-- 4. è¨­å®šé  -->
<div id="view-setup" class="page-view">
    <div class="section-title">âš™ï¸ ç³»çµ±è¨­å®š</div>
    <div class="card-box">
        <div style="margin-bottom:15px; text-align:left">
            <label style="display:block;margin-bottom:6px;font-weight:600">å–®ä½åç¨±</label>
            <input type="text" id="in-unit" class="form-control" placeholder="ä¾‹å¦‚ï¼šæ­¥ä¸€é€£">
        </div>

        <div class="setup-tabs">
            <div class="st-tab active" onclick="switchSetupTab('off', this)">è»å®˜</div>
            <div class="st-tab" onclick="switchSetupTab('nco', this)">å£«å®˜</div>
            <div class="st-tab" onclick="switchSetupTab('sol', this)">å£«å…µ</div>
            <div class="st-tab" onclick="switchSetupTab('tra', this)">è¨“å“¡</div>
            <div class="st-tab" onclick="switchSetupTab('rs', this)">äº‹æ•…åŸå› </div>
        </div>

        <div id="edit-off" class="setup-editor active">
            <button class="tool-btn" onclick="insertGroup('in-off')">â• åŠ å…¥åˆ†çµ„</button>
            <textarea id="in-off" class="setup-textarea"></textarea>
        </div>
        <div id="edit-nco" class="setup-editor">
            <button class="tool-btn" onclick="insertGroup('in-nco')">â• åŠ å…¥åˆ†çµ„</button>
            <textarea id="in-nco" class="setup-textarea"></textarea>
        </div>
        <div id="edit-sol" class="setup-editor">
            <button class="tool-btn" onclick="insertGroup('in-sol')">â• åŠ å…¥åˆ†çµ„</button>
            <textarea id="in-sol" class="setup-textarea"></textarea>
        </div>
        <div id="edit-tra" class="setup-editor">
            <button class="tool-btn" onclick="insertGroup('in-tra')">â• åŠ å…¥åˆ†çµ„</button>
            <textarea id="in-tra" class="setup-textarea"></textarea>
        </div>
        <div id="edit-rs" class="setup-editor">
            <textarea id="in-rs" class="setup-textarea" style="height:120px"></textarea>
        </div>

        <div style="margin-top:20px"><button class="btn btn-green" onclick="saveSetup()">âœ… å„²å­˜è¨­å®š</button></div>
        <div style="margin-top:20px; border-top:1px solid #eee; padding-top:15px; display:flex; justify-content:center; gap:20px">
            <button style="background:none;border:none;color:#6b7280;text-decoration:underline" onclick="exportData()">åŒ¯å‡ºå‚™ä»½</button>
            <button style="background:none;border:none;color:#6b7280;text-decoration:underline" onclick="importData()">é‚„åŸå‚™ä»½</button>
        </div>
    </div>
</div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('home', this)"><div class="nav-icon">ğŸ </div><span>ç¸½è¦½</span></div>
    <div class="nav-item" onclick="switchTab('roster', this)"><div class="nav-icon">ğŸ“</div><span>é»å</span></div>
    <div class="nav-item" onclick="switchTab('history', this)"><div class="nav-icon">ğŸ“…</div><span>ç´€éŒ„</span></div>
    <div class="nav-item" onclick="switchTab('setup', this)"><div class="nav-icon">âš™ï¸</div><span>è¨­å®š</span></div>
</div>

<div id="modal" class="modal-overlay">
    <div class="modal-box">
        <h3 id="m-name" style="margin:0 0 15px 0;text-align:center;color:#111827"></h3>
        <input type="text" id="m-note" class="form-control" placeholder="å‚™è¨» (ä¾‹å¦‚: 21æ”¶)..." style="margin-bottom:10px">
        <div class="opt-grid" id="m-opts"></div>
        <div style="display:flex; gap:10px; margin-top:15px">
             <button class="btn btn-dark" style="flex:1" onclick="setSt(null)">æ¸…é™¤ç‹€æ…‹</button>
             <button class="btn btn-red" style="flex:1" onclick="closeModal()">å–æ¶ˆ</button>
        </div>
        <div style="margin-top:15px; display:flex; justify-content:center; gap:8px;">
            <input type="checkbox" id="m-lock" style="transform:scale(1.3)"> <label for="m-lock">ğŸ”’ é–å®š</label>
        </div>
    </div>
</div>
<div id="toast" class="toast"></div>

<script>
const K_DATA = 'army_v3_data', K_HIS = 'army_v3_his';
let D = { u:'', o:[], n:[], s:[], t:[], rs:'', st:{}, nt:{}, lck:{}, tm:{} };
let curFilter='all', curUser='', isAccMode=false, longPressTimer;

document.addEventListener('DOMContentLoaded', () => {
    loadData(); updateTime(); setInterval(updateTime, 60000);
    document.getElementById('his-date').valueAsDate = new Date();
    switchTab('home', document.querySelector('.nav-item'));
});

function updateTime() {
    const now = new Date(), days = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
    document.getElementById('dash-date').innerText = `${now.getMonth()+1}/${now.getDate()} (é€±${days[now.getDay()]})`;
    document.getElementById('dash-time').innerText = now.toTimeString().slice(0, 5);
}
function switchTab(id, el) {
    document.querySelectorAll('.page-view').forEach(p => p.classList.remove('active'));
    document.getElementById('view-'+id).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    if(el) el.classList.add('active');
    if(id==='home') renderDashboard(); if(id==='roster') renderRoster(); if(id==='history') renderHisList(); if(id==='setup') fillSetup();
}
function loadData() {
    const raw = localStorage.getItem(K_DATA);
    if(raw) { D = JSON.parse(raw); if(!D.st) D.st={}; if(!D.nt) D.nt={}; if(!D.lck) D.lck={}; }
    fillSetup(); renderDashboard();
}
function saveData() { localStorage.setItem(K_DATA, JSON.stringify(D)); }
function parseList(str) { return str ? str.split(/[\s,ã€\n]+/).filter(x=>x.trim()) : []; }

/* é»åé‚è¼¯ */
function setFilter(type, el) { curFilter=type; document.querySelectorAll('.ft-btn').forEach(b=>b.classList.remove('active')); el.classList.add('active'); renderRoster(); }

function toggleMode() {
    isAccMode = !isAccMode;
    const btn = document.getElementById('mode-btn');
    if(isAccMode) { btn.innerText = "âš ï¸ äº‹æ•…æ¨¡å¼ (é–‹å•Ÿ)"; btn.classList.add('active'); showToast("é»æ“Šå¡ç‰‡å°‡é–‹å•Ÿäº‹æ•…é¸å–®"); }
    else { btn.innerText = "âš ï¸ ä¸€èˆ¬æ¨¡å¼"; btn.classList.remove('active'); showToast("é»æ“Šå¡ç‰‡æ¨™è¨˜å¯¦åˆ°"); }
}

function renderRoster() {
    const grid = document.getElementById('roster-grid'); grid.innerHTML = '';
    const search = document.getElementById('search-input').value.toLowerCase();
    let lists = [];
    if(curFilter==='all') lists=[{k:'o',d:D.o},{k:'n',d:D.n},{k:'s',d:D.s},{k:'t',d:D.t}];
    else if(curFilter==='off') lists=[{k:'o',d:D.o}]; else if(curFilter==='nco') lists=[{k:'n',d:D.n}];
    else if(curFilter==='sol') lists=[{k:'s',d:D.s}]; else if(curFilter==='tra') lists=[{k:'t',d:D.t}];

    let totalC=0, presC=0;
    lists.forEach(group => {
        group.d.forEach(name => {
            if(name.startsWith('-') || name.startsWith('#')) {
                if(!search) {
                    const sep = document.createElement('div'); sep.className='sep-row';
                    sep.innerHTML = `<div class="sep-line"></div>${name.replace(/[-#]/g,'').trim()}<div class="sep-line"></div>`;
                    grid.appendChild(sep);
                }
                return;
            }
            if(search && !name.toLowerCase().includes(search)) return;
            totalC++; const st = D.st[name]; if(st==='p') presC++;

            const card = document.createElement('div');
            let cls = 'r-card', badgeHtml = '';
            if(st==='p') cls += ' st-p';
            else if(st) {
                cls += ' st-e';
                let color = 'bg-org';
                if(['è½‰è¨º','ä½é™¢','éš”é›¢','ç™¼ç‡’'].some(k=>st.includes(k))) color='bg-red';
                else if(['è¡›å“¨','å®‰å®˜','æˆ°æƒ…'].some(k=>st.includes(k))) color='bg-green';
                else if(['å…¬å·®','å—è¨“','æ”¯æ´'].some(k=>st.includes(k))) color='bg-blue';
                badgeHtml = `<div class="rc-badge ${color}">${st}</div>`;
            }
            let nameHtml = `<div class="rc-name ${name.length>3?'long':''}">${name}</div>`;
            if(D.nt[name]) nameHtml += `<div class="rc-sub">ğŸ“${D.nt[name]}</div>`;
            if(D.lck[name]) badgeHtml += `<div class="rc-lock">ğŸ”’</div>`;

            card.className = cls;
            card.innerHTML = badgeHtml + nameHtml;
            
            // é»æ“Šäº‹ä»¶
            card.onclick = () => handleCardClick(name);
            // é•·æŒ‰äº‹ä»¶ (æ‰‹æ©Ÿå°ˆç”¨)
            card.addEventListener('touchstart', () => { longPressTimer = setTimeout(() => openModal(name), 600); }, {passive:true});
            card.addEventListener('touchend', () => { clearTimeout(longPressTimer); }, {passive:true});
            
            grid.appendChild(card);
        });
    });
    document.getElementById('r-pres').innerText = presC; document.getElementById('r-tot').innerText = totalC;
    const abs = totalC - presC - Object.values(D.st).filter(v=>v && v!=='p').length;
    document.getElementById('mini-status-text').innerText = abs===0 ? "âœ… å…¨å“¡åˆ°é½Š" : `âš ï¸ é‚„æœ‰ ${abs} äººæœªåˆ°`;
}

function handleCardClick(name) {
    if(navigator.vibrate) navigator.vibrate(10);
    // 1. é–å®šæ™‚ -> é–‹è¦–çª—
    // 2. äº‹æ•…æ¨¡å¼é–‹å•Ÿ -> é–‹è¦–çª—
    // 3. å·²ç¶“æœ‰äº‹æ•…(ä¸”ä¸æ˜¯å¯¦åˆ°) -> é–‹è¦–çª— (é˜²æ­¢èª¤è§¸å°±æŠŠäº‹æ•…æ´—æ‰)
    if(D.lck[name] || isAccMode || (D.st[name] && D.st[name] !== 'p')) {
        openModal(name);
    } else {
        // ä¸€èˆ¬æ¨¡å¼ï¼šåˆ‡æ› å¯¦åˆ°/é‡ç½®
        if(D.st[name] === 'p') delete D.st[name]; else D.st[name] = 'p';
        saveData(); renderRoster();
    }
}
function markSmart() {
    let count=0; [...D.o,...D.n,...D.s,...D.t].forEach(n=>{ if(!n.startsWith('-')&&!n.startsWith('#')&&!D.st[n]){D.st[n]='p'; count++;}});
    if(count>0){ saveData(); renderRoster(); renderDashboard(); showToast(`âš¡ å·²å°‡ ${count} å“¡æ¨™è¨˜ç‚ºå¯¦åˆ°`); } else showToast("ç„¡é ˆæ¨™è¨˜");
}

/* å½ˆçª— */
function openModal(name) {
    curUser = name;
    document.getElementById('m-name').innerText = name + (D.st[name] && D.st[name]!=='p' ? ` (${D.st[name]})` : '');
    document.getElementById('m-note').value = D.nt[name] || '';
    document.getElementById('m-lock').checked = !!D.lck[name];
    const c = document.getElementById('m-opts'); c.innerHTML = '';
    
    // è£œå›ã€Œå¯¦åˆ°ã€æŒ‰éˆ•
    const btnP = document.createElement('button');
    btnP.className = 'btn btn-green'; btnP.innerText = 'å¯¦åˆ°'; btnP.onclick = () => setSt('p');
    c.appendChild(btnP);

    (D.rs || "").split(/[,ï¼Œ]/).forEach(r => {
        if(!r.trim()) return;
        const b = document.createElement('button');
        b.className = 'btn'; b.style.background='#f3f4f6'; b.innerText = r;
        b.onclick = () => setSt(r); c.appendChild(b);
    });
    document.getElementById('modal').classList.add('show');
}
function closeModal() { document.getElementById('modal').classList.remove('show'); }
function setSt(status) {
    const note = document.getElementById('m-note').value.trim();
    if(status === null) { delete D.st[curUser]; delete D.nt[curUser]; delete D.lck[curUser]; }
    else { D.st[curUser]=status; if(note) D.nt[curUser]=note; else delete D.nt[curUser]; if(document.getElementById('m-lock').checked) D.lck[curUser]=true; else delete D.lck[curUser]; }
    saveData(); closeModal(); renderRoster();
}

/* è¨­å®šèˆ‡å…¶ä»– */
function fillSetup() {
    document.getElementById('in-unit').value = D.u || '';
    document.getElementById('in-off').value = D.o.join(' '); document.getElementById('in-nco').value = D.n.join(' ');
    document.getElementById('in-sol').value = D.s.join(' '); document.getElementById('in-tra').value = D.t.join(' ');
    document.getElementById('in-rs').value = D.rs || "ä¼‘å‡,å¤–å®¿,è£œä¼‘,è¡›å“¨,å®‰å®˜,æˆ°æƒ…,å…¬å·®,å—è¨“,æ”¯æ´,è½‰è¨º,ä½é™¢,éš”é›¢,æ´½å…¬";
    document.getElementById('dash-unit').innerText = D.u || 'æœªè¨­å®šå–®ä½';
}
function saveSetup() {
    D.u = document.getElementById('in-unit').value.trim();
    D.o = parseList(document.getElementById('in-off').value); D.n = parseList(document.getElementById('in-nco').value);
    D.s = parseList(document.getElementById('in-sol').value); D.t = parseList(document.getElementById('in-tra').value);
    D.rs = document.getElementById('in-rs').value.trim();
    saveData(); showToast("âœ… è¨­å®šå·²å„²å­˜"); renderDashboard(); fillSetup();
}
function switchSetupTab(targetId, el) {
    document.querySelectorAll('.setup-editor').forEach(e => e.classList.remove('active'));
    document.getElementById('edit-'+targetId).classList.add('active');
    document.querySelectorAll('.st-tab').forEach(t => t.classList.remove('active')); el.classList.add('active');
}
function insertGroup(id) { const name=prompt("è¼¸å…¥åˆ†çµ„åç¨±:"); if(name) document.getElementById(id).value += ` ---${name}--- \n`; }

function renderDashboard() {
    let stats = {t:0,p:0,e:0,detail:{}}, all=[...D.o,...D.n,...D.s,...D.t].filter(n=>!n.startsWith('-')&&!n.startsWith('#'));
    all.forEach(n=>{ stats.t++; const s=D.st[n]; if(s==='p') stats.p++; else if(s){ stats.e++; if(!stats.detail[s]) stats.detail[s]=[]; stats.detail[s].push(n); }});
    const abs = stats.t - stats.p - stats.e;
    document.getElementById('d-pres').innerText = stats.p; document.getElementById('d-abs').innerText = abs;
    
    const mkRow=(n,arr)=>{
        const v=arr.filter(x=>!x.startsWith('-')&&!x.startsWith('#')), t=v.length; let p=0,e=0;
        v.forEach(x=>{if(D.st[x]==='p')p++;else if(D.st[x])e++;}); return `<tr><td>${n}</td><td>${t}</td><td style="color:#059669">${p}</td><td style="color:#f59e0b">${e}</td><td style="color:#dc2626">${t-p-e}</td></tr>`;
    };
    document.getElementById('rank-tbody').innerHTML = mkRow('è»å®˜',D.o)+mkRow('å£«å®˜',D.n)+mkRow('å£«å…µ',D.s)+mkRow('è¨“å“¡',D.t);
    
    const db=document.getElementById('detail-box'), dc=document.getElementById('detail-content');
    if(stats.e>0){ db.style.display='block'; let h=''; for(let[r,l]of Object.entries(stats.detail)) h+=`<div><strong>${r}</strong> (${l.length}): ${l.map(x=>x+(D.nt[x]?`(${D.nt[x]})`:'')).join('ã€')}</div>`; dc.innerHTML=h; } else db.style.display='none';
}

function copyReport(isCSM) {
    const all = [...D.o,...D.n,...D.s,...D.t].filter(n=>!n.startsWith('-')&&!n.startsWith('#'));
    let t=0,p=0,e=0,details={};
    all.forEach(n=>{ t++; const s=D.st[n]; if(s==='p')p++; else if(s){ e++; if(!details[s])details[s]=[]; details[s].push(n); } });
    if(t-p-e>0 && !confirm(`é‚„æœ‰ ${t-p-e} äººæœªåˆ°ï¼Œç¢ºå®šç”¢å‡ºï¼Ÿ`)) return;
    
    const now=new Date(), time=`${now.getMonth()+1}/${now.getDate()} ${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}`;
    let txt = "";
    if(isCSM) {
        txt = `ç‡Ÿå£«ç£å¥½\n\n${D.u}å›å ±ï¼ˆ${now.getMonth()+1}/${now.getDate()}ï¼‰\næ‡‰åˆ°ï¼š${t}å“¡\nå¯¦åˆ°ï¼š${p}å“¡\näº‹æ•…ï¼š${e}å“¡\n`;
        let r21=[],r24=[],others=[];
        for(let[k,l]of Object.entries(details)) l.forEach(n=>{ const nt=(D.nt[n]||"").toLowerCase(); if(nt.includes('21'))r21.push(n); else if(nt.includes('24'))r24.push(n); else others.push({n,r:k}); });
        if(r21.length) txt+=`21æ”¶å‡ï¼š${r21.length}å“¡ (${r21.join('ã€')})\n`;
        if(r24.length) txt+=`24æ”¶å‡ï¼š${r24.length}å“¡ (${r24.join('ã€')})\n`;
        let om={}; others.forEach(x=>{if(!om[x.r])om[x.r]=[]; om[x.r].push(x.n)});
        for(let[k,l]of Object.entries(om)) txt+=`${k}ï¼š${l.map(x=>x+(D.nt[x]?`(${D.nt[x]})`:'')).join('ã€')}\n`;
        if(e===0) txt+="ç„¡äº‹æ•…äººå“¡\n";
    } else {
        txt=`ã€${D.u}é»åå›å ±ã€‘\næ™‚é–“ï¼š${time}\næ‡‰åˆ°ï¼š${t}å“¡\nå¯¦åˆ°ï¼š${p}å“¡\näº‹æ•…ï¼š${e}å“¡\n--------------\n`;
        if(e>0) for(let[k,l]of Object.entries(details)) txt+=`${k} (${l.length})ï¼š${l.map(x=>x+(D.nt[x]?`[${D.nt[x]}]`:'')).join('ã€')}\n`;
        else txt+="ç„¡äº‹æ•…äººå“¡\n";
    }
    const ta=document.createElement("textarea"); ta.value=txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); showToast("ğŸ“‹ è¤‡è£½æˆåŠŸ");
}

function resetAll(){if(confirm("é‡ç½®æ‰€æœ‰ç‹€æ…‹?")){D.st={};D.nt={};D.lck={};D.tm={};saveData();renderDashboard();showToast("ğŸ”„ å·²é‡ç½®");}}
function showToast(m){const t=document.getElementById('toast');t.innerText=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000);}
function getHis(){return JSON.parse(localStorage.getItem(K_HIS)||'{}')}
function saveHis(){const d=document.getElementById('his-date').value,p=document.getElementById('his-period').value;if(!d)return alert("é¸æ—¥æœŸ");const h=getHis();h[`${d}_${p}`]=D;localStorage.setItem(K_HIS,JSON.stringify(h));showToast("âœ… å·²å­˜æª”");renderHisList();}
function loadHis(){const k=`${document.getElementById('his-date').value}_${document.getElementById('his-period').value}`,h=getHis();if(h[k]&&confirm("è®€å–èˆŠç´€éŒ„?")){D=h[k];saveData();renderDashboard();showToast("âœ… è®€å–æˆåŠŸ");switchTab('home');}else alert("ç„¡ç´€éŒ„");}
function renderHisList(){const c=document.getElementById('his-list');c.innerHTML='';Object.keys(getHis()).sort().reverse().forEach(k=>{const d=document.createElement('div');d.style.cssText="display:flex;justify-content:space-between;padding:12px;background:white;border-radius:10px;border:1px solid #eee;";d.innerHTML=`<span>${k}</span><span style="color:red;cursor:pointer" onclick="delHis('${k}')">åˆªé™¤</span>`;c.appendChild(d);});}
function delHis(k){if(confirm("åˆªé™¤?")){const h=getHis();delete h[k];localStorage.setItem(K_HIS,JSON.stringify(h));renderHisList();}}
function exportData(){navigator.clipboard.writeText(JSON.stringify({cur:D,his:getHis()})).then(()=>showToast("å·²è¤‡è£½å‚™ä»½"),()=>alert("è¤‡è£½å¤±æ•—"));}
function importData(){const s=prompt("è²¼ä¸Šå‚™ä»½ç¢¼");if(s){try{const d=JSON.parse(s);D=d.cur;localStorage.setItem(K_DATA,JSON.stringify(D));localStorage.setItem(K_HIS,JSON.stringify(d.his));location.reload();}catch{alert("éŒ¯èª¤");}}}
</script>
</body>
</html>
