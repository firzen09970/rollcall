<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>éƒ¨éšŠé»åç³»çµ±(å„ªåŒ–ç‰ˆ2.0)</title>
<style>
:root{--bg:#f0f2f5;--txt:#333;--card:#fff;--border:#eee;--hl:#2c3e50;--btn-txt:#fff}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--txt);margin:0;padding:10px;text-align:center;user-select:none;padding-bottom:40px;transition:0.3s;-webkit-tap-highlight-color:transparent}
.top-bar{display:flex;gap:5px;margin-bottom:10px;justify-content:center;flex-wrap:wrap}
.btn-big{background:var(--hl);color:var(--btn-txt);border:none;padding:12px;border-radius:8px;font-weight:bold;flex:1;cursor:pointer;font-size:0.95rem;min-width:80px;box-shadow:0 2px 5px rgba(0,0,0,0.1);transition:transform 0.1s}
.btn-big:active{transform:scale(0.98)}
.stats-box{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:5px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:10px;position:sticky;top:0;z-index:99;overflow-x:auto}
.stats-table{width:100%;border-collapse:collapse;font-size:.9rem;color:var(--txt)}
.stats-table th,.stats-table td{padding:8px 2px;border-bottom:1px solid var(--border);text-align:center}
.stats-table th{background:var(--bg);color:var(--txt);font-size:0.8rem}
.r-off{color:#e74c3c;font-weight:bold} .r-nco{color:#3498db;font-weight:bold} .r-sol{color:#27ae60;font-weight:bold} .r-tra{color:#9b59b6;font-weight:bold}
.r-tot{font-weight:bold;background:var(--bg)}
.c-pre{color:#27ae60;background:rgba(39,174,96,.1)} .c-exc{color:#f39c12;background:rgba(243,156,18,.1)} .c-abs{color:#c0392b;opacity:.8}
.detail-board{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:15px;display:none;text-align:left;font-size:.9rem}
.detail-row{background:var(--bg);padding:8px 10px;border-radius:6px;border:1px solid var(--border);color:var(--txt);font-size:.95rem;margin-bottom:6px;line-height:1.4}
.breakdown{font-size:0.85rem;opacity:0.8;margin-left:5px;font-weight:normal}
.name-list{font-weight:normal;font-size:.9rem;margin-top:4px;padding-top:4px;border-top:1px dashed var(--border);display:block;color:var(--txt)}
/* Setup Area Styles */
.setup-area{background:var(--card);padding:15px;border-radius:12px;margin-bottom:20px;display:none;border:2px solid var(--hl);text-align:left;box-shadow:0 5px 15px rgba(0,0,0,0.2)}
.setup-area.show{display:block;animation:fadeIn 0.3s}
.input-group {margin-bottom: 15px; position: relative;}
.input-header {display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;}
.btn-insert {font-size:0.8rem; padding:4px 8px; background:#95a5a6; color:white; border:none; border-radius:4px; cursor:pointer;}
textarea, input[type="text"]{width:100%;padding:12px;border-radius:8px;border:1px solid #ccc;box-sizing:border-box;background:#fafafa;color:var(--txt);font-size:1rem;font-family:inherit}
textarea:focus, input[type="text"]:focus{outline:none;border-color:var(--hl);background:#fff}
textarea{height:70px;resize:vertical}
/* Rosters */
.control-bar{display:flex;gap:8px;margin-bottom:15px;justify-content:center;flex-wrap:wrap}
.btn-mode{padding:8px 12px;border-radius:20px;border:2px solid #7f8c8d;background:0 0;font-weight:bold;color:#555;cursor:pointer;font-size:0.9rem;transition:0.2s}
.btn-mode.active{background:#e67e22;color:#fff;border-color:#e67e22}
.roster-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(85px,1fr));gap:8px}
.p-btn{min-height:75px;border:none;border-radius:8px;color:#fff;font-size:1rem;font-weight:bold;cursor:pointer;position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:4px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.bg-off{background:#e74c3c} .bg-nco{background:#3498db} .bg-sol{background:#27ae60} .bg-tra{background:#9b59b6}
.st-pre{background:#555!important;opacity:.5;text-decoration:line-through}
.st-pre::after{content:'âœ”';position:absolute;top:4px;right:4px;font-size:0.8rem}
.st-exc{background:#f39c12!important;border:2px solid #d35400;color:#fff}
.st-tag{font-size:.7rem;background:rgba(0,0,0,.25);padding:2px 6px;border-radius:4px;margin-top:3px}
.st-note{font-size:.7rem;color:#fff;background:rgba(0,0,0,0.6);padding:1px 5px;border-radius:3px;margin-top:2px;max-width:95%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.st-sub{font-size:0.75rem;opacity:0.9;font-weight:normal;margin-top:1px}
.st-lock::before{content:'ğŸ”’';position:absolute;top:4px;left:4px;font-size:0.8rem}
.st-time{font-size:0.65rem;position:absolute;bottom:2px;right:4px;opacity:0.8;font-weight:normal}
.sep-row{grid-column:1/-1;background:#ecf0f1;color:#2c3e50;padding:6px;font-size:0.9rem;font-weight:bold;border-radius:6px;margin:8px 0 4px 0;text-align:center;border-left:4px solid var(--hl)}
/* Modals */
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:none;justify-content:center;align-items:center;z-index:200;backdrop-filter:blur(2px)}
.modal.show{display:flex;animation:fadeIn 0.2s}
.m-content{background:var(--card);padding:20px;border-radius:16px;width:85%;max-width:340px;box-shadow:0 10px 25px rgba(0,0,0,0.2)}
.opts{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:10px}
.o-btn{padding:12px 2px;border:none;border-radius:8px;color:#fff;cursor:pointer;font-size:.9rem;font-weight:bold}
.bg-v{background:#e67e22} .bg-g{background:#2c3e50} .bg-s{background:#c0392b} .bg-d{background:#8e44ad}
.history-panel{background:var(--bg);padding:15px;border-radius:12px;margin-bottom:20px;border:2px solid var(--hl);display:none}
.history-panel.show{display:block}
.copy-btn{width:100%;padding:12px;background:#27ae60;color:white;border:none;border-radius:8px;font-weight:bold;margin-bottom:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;font-size:1rem;box-shadow:0 3px 6px rgba(39,174,96,0.3)}
.copy-btn:active{transform:translateY(2px)}
.search-input{width:100%;padding:12px;border-radius:30px;border:2px solid #3498db;text-align:center;font-size:1rem;background:var(--card);color:var(--txt);margin-bottom:10px}
.progress-bar{height:8px;width:100%;background:#eee;border-radius:4px;margin-top:5px;display:flex;overflow:hidden}
.pb-p{background:#27ae60;height:100%} .pb-e{background:#f39c12;height:100%} .pb-a{background:#c0392b;height:100%}
.switch-label{display:flex;align-items:center;justify-content:center;gap:10px;margin-top:15px;background:#f0f0f0;padding:10px;border-radius:8px;cursor:pointer;color:#333}
/* Counters */
.counter-box{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:20px;padding:10px;background:var(--card);border-top:2px solid var(--border)}
.cnt-item{display:flex;flex-direction:column;align-items:center;background:var(--bg);padding:5px 10px;border-radius:8px;border:1px solid var(--border);min-width:80px}
.cnt-val{font-size:1.5rem;font-weight:bold;margin:5px 0}
.cnt-ctrl{display:flex;gap:5px}
.cnt-btn{width:30px;height:30px;border:none;border-radius:50%;font-weight:bold;cursor:pointer;background:var(--hl);color:#fff}
/* Helpers */
.help-panel{background:var(--card);padding:15px;border-radius:12px;margin-bottom:20px;border:2px solid var(--hl);display:none;text-align:left;box-shadow:0 4px 10px rgba(0,0,0,0.1)}
.help-panel.show{display:block}
.help-list{padding-left:20px;margin:0;font-size:0.95rem;line-height:1.8;color:var(--txt)}
.warning-footer{position:fixed;bottom:0;left:0;width:100%;background:#f1c40f;color:#333;padding:5px 0;font-size:0.85rem;font-weight:bold;text-align:center;box-shadow:0 -2px 5px rgba(0,0,0,0.1);z-index:300}
@keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>

<div class="top-bar">
    <button class="btn-big" onclick="toggleSetup()">âš™ï¸ è¨­å®š</button>
    <button class="btn-big" style="background:#8e44ad" onclick="toggleHistory()">ğŸ“… æ­·å²</button>
    <button class="btn-big" style="background:#3498db" onclick="toggleHelp()">ğŸ“– èªªæ˜</button>
</div>

<div id="help-area" class="help-panel">
    <h3 style="margin-top:0;color:#2980b9">ğŸ“– 2.0ç‰ˆ ä½¿ç”¨èªªæ˜</h3>
    <ul class="help-list">
        <li><b>1. å»ºç«‹è³‡æ–™ï¼š</b>é»é¸ã€Œè¨­å®šã€ï¼Œæ”¯æ´å¿«é€ŸåŠ å…¥æ’çµ„åˆ†éš”ç·šã€‚</li>
        <li><b>2. é»åæ“ä½œï¼š</b>é»æ“Šè¨­ç‚ºã€Œå¯¦åˆ°ã€ï¼›é–‹å•Ÿã€Œâš ï¸ äº‹æ•…ã€æ¨¡å¼å¯æ¨™è¨˜ä¼‘å‡ã€è¡›å“¨ç­‰ã€‚</li>
        <li><b>3. å¿«é€Ÿå›å ±ï¼š</b>
            <ul>
                <li>**ç‡Ÿå£«ç£å›å ±ï¼š** äº‹æ•…å‚™è¨»è«‹å¡«ã€Œ21æ”¶ã€ã€Œ24æ”¶ã€ä»¥åˆ©çµ±è¨ˆã€‚</li>
                <li>**ä¸€éµå‚™ä»½ï¼š** è¨­å®šé é¢æ–°å¢ä¸€éµå‚™ä»½æŒ‰éˆ•ï¼Œç›´æ¥è¤‡è£½ä»£ç¢¼ã€‚</li>
            </ul>
        </li>
    </ul>
    <div style="text-align:center;margin-top:15px"><button class="btn-big" style="background:#34495e;width:100px" onclick="toggleHelp()">é—œé–‰</button></div>
</div>

<div id="setup-area" class="setup-area">
    <h3 style="margin-top:0;color:var(--hl)">ğŸ¢ å–®ä½è¨­å®š</h3>
    <div class="input-group"><input type="text" id="in-unit" placeholder="è¼¸å…¥å–®ä½åç¨± (ä¾‹å¦‚ï¼šæ­¥ä¸€é€£)"></div>
    
    <h3 style="color:var(--hl)">ğŸ› ï¸ è‡ªè¨‚äº‹æ•…æŒ‰éˆ•</h3>
    <div class="input-group"><textarea id="in-reasons" style="height:50px" placeholder="é è¨­ï¼šä¼‘å‡,å¤–å®¿,è£œä¼‘,è¡›å“¨,å®‰å®˜..."></textarea></div>

    <h3>äººå“¡åå–®è¨­å®š</h3>
    <div style="font-size:0.85rem;color:#7f8c8d;margin-bottom:10px">æç¤ºï¼šå¯ç›´æ¥å¾ Excel æˆ– Line è²¼ä¸Šäººåï¼Œç©ºæ ¼éš”é–‹ã€‚é»æ“ŠæŒ‰éˆ•æ’å…¥åˆ†çµ„ç·šã€‚</div>

    <div class="input-group">
        <div class="input-header"><span style="color:#e74c3c;font-weight:bold">ğŸ›‘ è»å®˜</span><button class="btn-insert" onclick="insertSep('in-off')">â• æ’å…¥æ’çµ„</button></div>
        <textarea id="in-off" placeholder="ä¸Šå°‰å³â—‹â—‹ ä¸­å°‰å¼µâ—‹â—‹"></textarea>
    </div>

    <div class="input-group">
        <div class="input-header"><span style="color:#3498db;font-weight:bold">ğŸ”· å£«å®˜</span><button class="btn-insert" onclick="insertSep('in-nco')">â• æ’å…¥æ’çµ„</button></div>
        <textarea id="in-nco" placeholder="å£«å®˜é•·è¬â—‹â—‹"></textarea>
    </div>

    <div class="input-group">
        <div class="input-header"><span style="color:#27ae60;font-weight:bold">ğŸŸ© å£«å…µ</span><button class="btn-insert" onclick="insertSep('in-sol')">â• æ’å…¥æ’çµ„</button></div>
        <textarea id="in-sol" placeholder="ä¸Šå…µç‹å°æ˜ ä¸€å…µæå¤§è¯"></textarea>
    </div>

    <div class="input-group">
        <div class="input-header"><span style="color:#9b59b6;font-weight:bold">ğŸŸ£ è¨“å“¡</span><button class="btn-insert" onclick="insertSep('in-tra')">â• æ’å…¥æ’çµ„</button></div>
        <textarea id="in-tra" placeholder="äºŒå…µå¼µç‹—è›‹"></textarea>
    </div>

    <h3 style="color:var(--hl)">ğŸ”¢ è¨ˆæ•¸å™¨è¨­å®š</h3>
    <div class="input-group"><input type="text" id="in-counters" placeholder="ä¾‹å¦‚ï¼šä¾¿ç•¶,T65K2,ç„¡ç·šé›»"></div>
    
    <button class="btn-big" style="background:#27ae60;margin-bottom:15px;width:100%" onclick="saveData()">âœ… å„²å­˜ä¸¦ç”Ÿæˆé»åæ¿</button>
    
    <div style="border-top:1px solid #ccc;padding-top:15px;display:flex;gap:10px">
        <button class="btn-big" style="background:#7f8c8d" onclick="exportData()">ğŸ“¤ ä¸€éµå‚™ä»½ä»£ç¢¼</button>
        <button class="btn-big" style="background:#7f8c8d" onclick="importData()">ğŸ“¥ ä¸€éµè®€å–ä»£ç¢¼</button>
    </div>
</div>

<div id="history-area" class="history-panel">
    <h3>ğŸ“… æ­·å²ç´€éŒ„</h3>
    <div style="display:flex;justify-content:space-between;margin-bottom:10px;background:var(--card);padding:8px;border-radius:6px;border:1px solid var(--border)">
        <span style="font-size:0.9rem">å·²å­˜: <b id="history-count" style="color:#e67e22">0</b> ç­†</span>
        <button onclick="showHistoryList()" style="background:#3498db;color:white;border:none;padding:5px 10px;border-radius:4px;font-weight:bold">ğŸ‘ï¸ æ¸…å–®</button>
    </div>
    <div style="display:flex;gap:5px;margin-bottom:10px">
        <input type="date" id="history-date" style="flex:2;padding:10px;border-radius:6px;border:1px solid #ccc">
        <select id="history-period" style="flex:1.5;padding:10px;border-radius:6px;border:1px solid #ccc;background:#fff"><option value="am">â˜€ ä¸Šåˆ</option><option value="pm">â›… ä¸‹åˆ</option><option value="night">ğŸŒ™ å¤œé–“</option></select>
    </div>
    <div style="display:flex;gap:10px"><button class="btn-big" style="background:#27ae60" onclick="saveToDate()">ğŸ“¥ å­˜æª”</button><button class="btn-big" style="background:#e67e22" onclick="loadFromDate()">ğŸ“¤ è®€å–</button></div>
    <div style="margin-top:15px;border-top:1px solid #ccc;padding-top:10px"><button class="btn-big" style="background:#c0392b;font-size:0.9rem" onclick="clearHistory()">ğŸ—‘ï¸ æ¸…é™¤å…¨éƒ¨</button></div>
</div>

<button class="copy-btn" style="background:#8e44ad" onclick="copyCSMReport()">ğŸ“‹ ä¸€éµç”¢å‡ºç‡Ÿå£«ç£é•·å›å ±</button>
<button class="copy-btn" onclick="copyReport()">ğŸ“‹ ä¸€éµç”¢å‡ºå€¼æ˜Ÿç¾¤çµ„å›å ±</button>

<div class="stats-box">
    <table class="stats-table"><thead><tr><th>éšç´š</th><th>æ‡‰åˆ°</th><th>å¯¦åˆ°</th><th>äº‹æ•…</th><th>æœªé»</th></tr></thead><tbody id="stats-body"></tbody></table>
    <div class="progress-bar" id="p-bar"></div>
</div>
<div id="detail-board" class="detail-board"><b>ğŸ“‹ äº‹æ•…æ˜ç´°:</b> <div id="detail-tags" style="margin-top:5px"></div></div>

<div style="margin-bottom:10px"><input type="text" id="search-input" class="search-input" placeholder="ğŸ” è¼¸å…¥åå­—å¿«é€Ÿæ‰¾äºº..." oninput="filterRoster()"></div>

<div class="control-bar">
    <button id="mode-btn" class="btn-mode" onclick="toggleMode()">âš ï¸ äº‹æ•…: é—œ</button>
    <button class="btn-mode" style="border-color:#27ae60;color:#27ae60" onclick="markAllPresent()">âš¡ é¤˜å“¡å…¨åˆ°</button>
    <button id="sort-btn" class="btn-mode" style="border-color:#8e44ad;color:#8e44ad" onclick="toggleSort()">ğŸ”ƒ æ’åº: åŸåº</button>
    <button class="btn-mode" style="border-color:#c0392b;color:#c0392b" onclick="showMissing()">ğŸ“¢ æŸ¥æœªåˆ°</button>
    <button class="btn-mode" style="background:#95a5a6;color:#fff;border:none" onclick="resetAll()">ğŸ”„ é‡ç½®</button>
</div>
<div id="roster" class="roster-grid"></div>
<div id="counters-area" class="counter-box"></div>

<div id="modal" class="modal"><div class="m-content"><h3 id="m-name"></h3>
<div style="margin-bottom:10px"><input id="note-input" type="text" placeholder="å‚™è¨» (å¦‚: 21æ”¶, å—è¨“, ç™¼ç‡’...)"></div>
<div style="display:flex;gap:5px;margin-bottom:10px"><input id="custom-r" style="flex:1;padding:10px;border:1px solid #ccc;border-radius:6px" placeholder="è‡ªè¨‚åŸå› "><button onclick="subCus()" style="background:#3498db;color:#fff;border:none;border-radius:4px;width:40px">OK</button></div>
<div class="opts" id="opts-container"></div>
<label class="switch-label"><input type="checkbox" id="lock-status"> ğŸ”’ é–å®šæ­¤ç‹€æ…‹</label>
<button class="o-btn" style="background:#95a5a6;width:100%;margin-top:10px" onclick="closeM()">å–æ¶ˆ</button></div></div>

<div id="his-list-modal" class="modal" style="z-index:250"><div class="m-content" style="max-height:80vh;display:flex;flex-direction:column"><h3 style="margin-top:0">ğŸ“œ å·²å­˜ç´€éŒ„</h3><div id="his-items-container" style="overflow-y:auto;flex:1;margin-bottom:10px;border:1px solid #eee;border-radius:6px"></div><button class="btn-big" style="background:#95a5a6" onclick="closeHisList()">é—œé–‰</button></div></div>

<div class="warning-footer">âš ï¸ ç”¢å‡ºæ•¸æ“šåƒ…ä¾›åƒè€ƒï¼Œæœ€çµ‚ç”±å€‹äººè² è²¬ã€‚</div>

<script>
const K_CUR='army_v2_cur',K_HIS='army_v2_his';
let D={o:[],n:[],s:[],t:[],st:{},nt:{},lck:{},tm:{},cnt:{},u:'',rs:'',cns:''},isM=false,isSorted=false,cur='',reportStr='';
const DEFAULT_REASONS = "ä¼‘å‡,å¤–å®¿,è£œä¼‘,è¡›å“¨,å®‰å®˜,æˆ°æƒ…,å…¬å·®,å—è¨“,æ”¯æ´,è½‰è¨º,ä½é™¢,éš”é›¢";
const DEFAULT_COUNTERS = "ä¾¿ç•¶,æ§æ";

document.addEventListener('DOMContentLoaded',()=>{
    document.getElementById('history-date').valueAsDate=new Date();
    load();updateHisCount();
});

// --- New Feature: Insert Separator ---
function insertSep(id){
    const name = prompt("è«‹è¼¸å…¥åˆ†çµ„/æ’çµ„åç¨± (ä¾‹å¦‚: ä¸€æ’, æ”¯æ´æ’):");
    if(name){
        const el = document.getElementById(id);
        const val = el.value;
        const start = el.selectionStart;
        const end = el.selectionEnd;
        const textToInsert = ` ---${name}--- `;
        el.value = val.substring(0, start) + textToInsert + val.substring(end);
        el.focus();
        el.selectionStart = el.selectionEnd = start + textToInsert.length;
    }
}

// --- Optimized Export/Import ---
function exportData(){
    const data={cur:JSON.parse(localStorage.getItem(K_CUR)||'{}'),his:JSON.parse(localStorage.getItem(K_HIS)||'{}')};
    const str = JSON.stringify(data);
    if(navigator.clipboard){
        navigator.clipboard.writeText(str).then(()=>alert("âœ… å‚™ä»½ç¢¼å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼\nè«‹ç›´æ¥å» Line æˆ–ç­†è¨˜æœ¬è²¼ä¸Šå³å¯ã€‚")).catch(()=>fallbackCopy(str));
    } else {
        fallbackCopy(str);
    }
}
function fallbackCopy(str){
    prompt("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ä¸€éµè¤‡è£½ï¼Œè«‹æ‰‹å‹•å…¨é¸è¤‡è£½ä¸‹æ–¹ä»£ç¢¼ï¼š", str);
}

function importData(){
    const str=prompt("è«‹è²¼ä¸Šå‚™ä»½ç¢¼:");
    if(str){
        try{
            const d=JSON.parse(str);
            if(d.cur&&d.his){
                localStorage.setItem(K_CUR,JSON.stringify(d.cur));
                localStorage.setItem(K_HIS,JSON.stringify(d.his));
                alert("âœ… è³‡æ–™é‚„åŸæˆåŠŸï¼");location.reload();
            }else throw new Error;
        }catch(e){alert("âŒ ä»£ç¢¼æ ¼å¼éŒ¯èª¤")}
    }
}

// --- Core Logic ---
function copyReport(){
    const abs = getAbsCount();
    if(abs > 0) return alert(`âš ï¸ é‚„æœ‰ ${abs} å“¡æœªé»åï¼\nè«‹æŒ‰ã€ŒğŸ“¢ æŸ¥æœªåˆ°ã€æŒ‰éˆ•ä¿®æ­£ã€‚`);
    if(!reportStr) return alert("ç„¡è³‡æ–™");
    navigator.clipboard.writeText(reportStr).then(()=>{alert("âœ… å·²è¤‡è£½å€¼æ˜Ÿç¾¤çµ„å›å ±ï¼");}).catch(e=>alert("è¤‡è£½å¤±æ•—"));
}
function toggleHelp(){document.getElementById('help-area').classList.toggle('show');document.getElementById('setup-area').classList.remove('show');document.getElementById('history-area').classList.remove('show')}
function toggleSetup(){document.getElementById('setup-area').classList.toggle('show');document.getElementById('help-area').classList.remove('show');document.getElementById('history-area').classList.remove('show')}
function toggleHistory(){document.getElementById('history-area').classList.toggle('show');document.getElementById('setup-area').classList.remove('show');document.getElementById('help-area').classList.remove('show');updateHisCount()}
function getHis(){const r=localStorage.getItem(K_HIS);return r?JSON.parse(r):{}}
function updateHisCount(){const h=getHis();document.getElementById('history-count').innerText=Object.keys(h).length}
function getAbsCount(){const all=[...D.o,...D.n,...D.s,...D.t];let abs=0;all.forEach(n=>{if(!D.st[n] && !n.startsWith('-'))abs++});return abs}
function saveToDate(){const d=document.getElementById('history-date').value,p=document.getElementById('history-period').value;if(!d)return alert("é¸æ—¥æœŸ");const abs=getAbsCount();if(abs>0&&!confirm(`âš ï¸ é‚„æœ‰ ${abs} å“¡æœªåˆ°ï¼ç¢ºå®šå­˜æª”ï¼Ÿ`))return;const k=d+'_'+p,h=getHis();h[k]=JSON.parse(JSON.stringify(D));localStorage.setItem(K_HIS,JSON.stringify(h));updateHisCount();alert("âœ… å·²å­˜æª”")}
function loadFromDate(){const d=document.getElementById('history-date').value,p=document.getElementById('history-period').value;loadHistoryKey(d+'_'+p, d)}
function clearHistory(){if(confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰æ­·å²ç´€éŒ„ï¼Ÿ"))localStorage.removeItem(K_HIS),updateHisCount(),alert("å·²æ¸…ç©º")}
function parse(t){return t?t.split(/[\s,ã€\n]+/).filter(x=>x.trim()):[]}
function toggleMode(){isM=!isM;const b=document.getElementById('mode-btn');b.innerText=isM?"âš ï¸ äº‹æ•…: é–‹":"âš ï¸ äº‹æ•…: é—œ";b.classList.toggle('active')}
function saveData(){
    D.u=document.getElementById('in-unit').value.trim();
    D.rs=document.getElementById('in-reasons').value.trim();
    D.cns=document.getElementById('in-counters').value.trim();
    D.o=parse(document.getElementById('in-off').value);D.n=parse(document.getElementById('in-nco').value);D.s=parse(document.getElementById('in-sol').value);D.t=parse(document.getElementById('in-tra').value);
    if(!D.o.length&&!D.n.length&&!D.s.length&&!D.t.length)return alert("è«‹è¼¸å…¥åå­—");
    persist();render();toggleSetup();
}
function persist(){localStorage.setItem(K_CUR,JSON.stringify(D))}
function load(){const r=localStorage.getItem(K_CUR);if(r){D=JSON.parse(r);if(!D.nt)D.nt={};if(!D.lck)D.lck={};if(!D.tm)D.tm={};if(!D.cnt)D.cnt={};fillSetup();render()}else{toggleSetup()}}
function fillSetup(){
    document.getElementById('in-unit').value=D.u||'';
    document.getElementById('in-reasons').value=D.rs||DEFAULT_REASONS;
    document.getElementById('in-counters').value=D.cns||DEFAULT_COUNTERS;
    document.getElementById('in-off').value=D.o.join(' ');document.getElementById('in-nco').value=D.n.join(' ');document.getElementById('in-sol').value=D.s.join(' ');document.getElementById('in-tra').value=D.t.join(' ');
}
function filterRoster(){const t=document.getElementById('search-input').value.toLowerCase();document.querySelectorAll('.p-btn').forEach(b=>{b.style.display=b.innerText.toLowerCase().includes(t)?'flex':'none'})}
function showMissing(){const m=[...D.o,...D.n,...D.s,...D.t].filter(n=>!D.st[n] && !n.startsWith('-'));if(m.length===0)return alert("ğŸ‘ å…¨å“¡å·²åˆ°");alert(`ğŸ“¢ æœªåˆ° (${m.length}å“¡)ï¼š\n\n${m.join('ã€')}`)}
function markAllPresent(){if(confirm("ä¸€éµå°‡æœªé»åè¨­ç‚ºå¯¦åˆ°ï¼Ÿ(ä¿ç•™é–å®š/äº‹æ•…)")){const now=new Date();const time=`${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;[...D.o,...D.n,...D.s,...D.t].forEach(n=>{if(!D.st[n] && !n.startsWith('-')){D.st[n]='p';D.tm[n]=time}});persist();render()}}
function toggleSort(){isSorted=!isSorted;const b=document.getElementById('sort-btn');b.innerText=isSorted?"ğŸ”ƒ æ’åº: æœªåˆ°å„ªå…ˆ":"ğŸ”ƒ æ’åº: åŸåº";b.classList.toggle('active');render()}

function render(){
    const c=document.getElementById('roster');c.innerHTML='';
    const processName=(r)=>{const m=r.match(/^(.*?)[ï¼ˆ\(](.*)[ï¼‰\)]$/);return m?{name:m[1],sub:m[2]}:{name:r,sub:''}};
    const renderGroup=(list, cls)=>{
        let sortedList = [...list];
        if(isSorted){
            sortedList = sortedList.filter(x => !x.startsWith('-') && !x.startsWith('#'));
            sortedList.sort((a,b)=>{
                const getScore=(n)=>{if(!D.st[n])return 0;if(D.st[n]!=='p')return 1;return 2;}
                return getScore(a)-getScore(b);
            });
        }
        sortedList.forEach(rawNm=>{
            // Divider Rendering
            if(!isSorted && (rawNm.startsWith('-') || rawNm.startsWith('#'))){
                const sep = document.createElement('div');
                sep.className = 'sep-row';
                sep.innerText = rawNm.replace(/[-#]/g, '').trim();
                c.appendChild(sep);
                return;
            }
            const {name,sub}=processName(rawNm);
            const b=document.createElement('button');b.className=`p-btn ${cls}`;
            const s=D.st[rawNm],note=D.nt?D.nt[rawNm]:'',lock=D.lck&&D.lck[rawNm],time=D.tm&&D.tm[rawNm]?D.tm[rawNm]:'';
            let h=`<span>${name}</span>`;
            if(sub)h+=`<span class="st-sub">${sub}</span>`;
            if(s&&s!=='p')h+=`<span class="st-tag">${s}</span>`;
            if(note)h+=`<span class="st-note">${note}</span>`;
            if(lock)b.classList.add('st-lock');
            if(s==='p'&&time)h+=`<span class="st-time">${time}</span>`;
            b.innerHTML=h;
            if(s==='p')b.classList.add('st-pre');else if(s)b.classList.add('st-exc');
            b.onclick=()=>{
                if(navigator.vibrate)navigator.vibrate(15);
                if(isM){
                    cur=rawNm;document.getElementById('m-name').innerText=name;
                    document.getElementById('custom-r').value='';
                    document.getElementById('note-input').value=D.nt&&D.nt[rawNm]?D.nt[rawNm]:'';
                    document.getElementById('lock-status').checked=!!(D.lck&&D.lck[rawNm]);
                    renderModalOpts();document.getElementById('modal').classList.add('show');
                }else{
                    if(D.st[rawNm]==='p'){
                        if(D.lck&&D.lck[rawNm])return alert("å·²é–å®šï¼");
                        D.st[rawNm]=null;delete D.tm[rawNm];
                    }else{
                        if(D.lck&&D.lck[rawNm])return alert("å·²é–å®šï¼");
                        D.st[rawNm]='p';
                        const now=new Date();D.tm[rawNm]=`${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
                    }
                    persist();render();
                }
            };c.appendChild(b)
        });
    };
    renderGroup(D.o,'bg-off');renderGroup(D.n,'bg-nco');renderGroup(D.s,'bg-sol');renderGroup(D.t,'bg-tra');
    renderCounters();
    updT();filterRoster();
}

function renderCounters(){
    const c=document.getElementById('counters-area');c.innerHTML='';
    const list = (D.cns || DEFAULT_COUNTERS).split(/[,ï¼Œ]/).map(x=>x.trim()).filter(x=>x);
    list.forEach(name=>{
        if(!D.cnt[name]) D.cnt[name]=0;
        const div = document.createElement('div');div.className='cnt-item';
        div.innerHTML=`<span style="font-size:0.8rem;font-weight:bold">${name}</span><span class="cnt-val">${D.cnt[name]}</span><div class="cnt-ctrl"><button class="cnt-btn" onclick="modCnt('${name}',-1)">-</button><button class="cnt-btn" onclick="modCnt('${name}',1)">+</button></div>`;
        c.appendChild(div);
    });
}
function modCnt(name, val){if(!D.cnt)D.cnt={};D.cnt[name]=(D.cnt[name]||0)+val;if(D.cnt[name]<0)D.cnt[name]=0;persist();renderCounters();}

function renderModalOpts(){
    const c=document.getElementById('opts-container');c.innerHTML='';
    (D.rs||DEFAULT_REASONS).split(/[,ï¼Œ]/).map(x=>x.trim()).filter(x=>x).forEach(r=>{
        const b=document.createElement('button');b.className='o-btn bg-v';
        if(['è¡›å“¨','å®‰å®˜','æˆ°æƒ…'].includes(r))b.className='o-btn bg-g';
        if(['è½‰è¨º','ä½é™¢','éš”é›¢'].includes(r))b.className='o-btn bg-s';
        if(['å…¬å·®','å—è¨“','æ”¯æ´'].includes(r))b.className='o-btn bg-d';
        b.innerText=r;b.onclick=()=>setS(r);c.appendChild(b)
    });
    const r=document.createElement('button');r.className='o-btn';r.style.background='#1abc9c';r.style.gridColumn='span 3';r.innerText='ç„¡äº‹æ•… (è¿”å›æœªåˆ°)';r.onclick=()=>setS(null);c.appendChild(r)
}
function subCus(){const v=document.getElementById('custom-r').value.trim();if(v)setS(v)}
function setS(v){
    D.st[cur]=v;
    const n=document.getElementById('note-input').value.trim();
    const locked=document.getElementById('lock-status').checked;
    if(!D.nt)D.nt={};if(!D.lck)D.lck={};
    if(n)D.nt[cur]=n;else delete D.nt[cur];
    if(locked)D.lck[cur]=true;else delete D.lck[cur];
    if(v==='p'||!v)delete D.tm[cur];
    closeM();persist();render()
}
function closeM(){document.getElementById('modal').classList.remove('show')}
function resetAll(){if(confirm("é‡ç½®ï¼Ÿ(é–å®šè€…ä¸è®Š)")){[...D.o,...D.n,...D.s,...D.t].forEach(n=>{if((!D.lck||!D.lck[n])&&!n.startsWith('-')){delete D.st[n];delete D.nt[n];delete D.tm[n]}});persist();render()}}

function calculateStats(){
    const calc=(l,k,res)=>{l.forEach(n=>{if(n.startsWith('-')||n.startsWith('#'))return;const s=D.st[n];if(s==='p')res[k].p++;else if(s){res[k].e++;if(!res.dt[s])res.dt[s]=[];res.dt[s].push(n)}})};
    const getListLen = (l) => l.filter(x=>!x.startsWith('-')&&!x.startsWith('#')).length;
    const R={o:{t:getListLen(D.o),p:0,e:0},n:{t:getListLen(D.n),p:0,e:0},s:{t:getListLen(D.s),p:0,e:0},t:{t:getListLen(D.t),p:0,e:0},dt:{}};
    calc(D.o,'o',R);calc(D.n,'n',R);calc(D.s,'s',R);calc(D.t,'t',R);
    R.tot={t:R.o.t+R.n.t+R.s.t+R.t.t,p:R.o.p+R.n.p+R.s.p+R.t.p,e:R.o.e+R.n.e+R.s.e+R.t.e}; 
    return R;
}

function updT(){
    const R = calculateStats();
    const tot = R.tot;
    const r=document.getElementById('stats-body');
    const row=(l,c,d)=>`<tr><td class="${c}">${l}</td><td>${d.t}</td><td class="c-pre">${d.p}</td><td class="c-exc">${d.e}</td><td class="c-abs">${d.t-d.p-d.e}</td></tr>`;
    r.innerHTML=row('è»å®˜','r-off',R.o)+row('å£«å®˜','r-nco',R.n)+row('å£«å…µ','r-sol',R.s)+row('è¨“å“¡','r-tra',R.t)+`<tr style="background:#eee;color:#000"><td class="r-tot">åˆè¨ˆ</td><td class="r-tot">${tot.t}</td><td class="r-tot c-pre">${tot.p}</td><td class="r-tot c-exc">${tot.e}</td><td class="r-tot c-abs">${tot.t-tot.p-tot.e}</td></tr>`;
    const pb=document.getElementById('p-bar');
    if(tot.t>0){const pp=(tot.p/tot.t)*100,ep=(tot.e/tot.t)*100,ap=((tot.t-tot.p-tot.e)/tot.t)*100;pb.innerHTML=`<div class="pb-p" style="width:${pp}%"></div><div class="pb-e" style="width:${ep}%"></div><div class="pb-a" style="width:${ap}%"></div>`;}
    
    const db=document.getElementById('detail-board'),dt=document.getElementById('detail-tags');dt.innerHTML='';
    let now=new Date(),u=D.u?D.u:"";
    const getName = (raw) => raw.split(/[ï¼ˆ\(]/)[0];
    const cleanNoteForDisplay = (note) => {
        if (!note) return '';
        return note.replace(/2[14]æ”¶|07æ”¶/g, '').trim();
    };

    reportStr=`ã€éƒ¨éšŠé»åå›å ±ã€‘\nå–®ä½ï¼š${u}\næ™‚é–“ï¼š${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')} (${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')})\n`;
    reportStr+=`æ‡‰åˆ°ï¼š${tot.t}å“¡ (å®˜${R.o.t} å£«${R.n.t} å…µ${R.s.t} è¨“${R.t.t})\n`;
    reportStr+=`å¯¦åˆ°ï¼š${tot.p}å“¡ (å®˜${R.o.p} å£«${R.n.p} å…µ${R.s.p} è¨“${R.t.p})\näº‹æ•…ï¼š${tot.e}å“¡ (å®˜${R.o.e} å£«${R.n.e} å…µ${R.s.e} è¨“${R.t.e})\næœªåˆ°ï¼š${tot.t-tot.p-tot.e}å“¡\n----------------\n`;

    if(tot.e>0){
        db.style.display='block';
        for(let[k,arr]of Object.entries(R.dt)){
            let co=0,cn=0,cs=0,ct=0;
            arr.forEach(nm=>{if(D.o.includes(nm))co++;else if(D.n.includes(nm))cn++;else if(D.s.includes(nm))cs++;else if(D.t.includes(nm))ct++});
            let namesForDisplay = arr.map(nm => {
                let cleanName = getName(nm);
                let note = D.nt && D.nt[nm] ? D.nt[nm] : '';
                let displayNote = cleanNoteForDisplay(note);
                return displayNote ? `${cleanName}[${displayNote}]` : cleanName;
            });
            let nameSummary = namesForDisplay.length > 1 ? `${namesForDisplay[0]}ç­‰${namesForDisplay.length}å“¡` : namesForDisplay[0];
            reportStr+=`${k}ï¼š${arr.length}å“¡ (${nameSummary})\n`;
            dt.innerHTML+=`<div class="detail-row"><b>${k}: ${arr.length}å“¡</b> <span class="breakdown">(å®˜${co} å£«${cn} å…µ${cs} è¨“${ct})</span><span class="name-list">(${namesForDisplay.join(' ')})</span></div>`
        }
    }else{db.style.display='none';reportStr+="ç„¡äº‹æ•…äººå“¡\n"}
}

const getRankCount = (list) => {
    let o=0, n=0, s=0, t=0;
    list.forEach(name => {
        if(D.o.includes(name)) o++;
        else if(D.n.includes(name)) n++;
        else if(D.s.includes(name)) s++;
        else if(D.t.includes(name)) t++;
    });
    return {o, n, s, t}; 
};

const formatRankSummary = (cnt) => {
    let rankParts = [];
    if (cnt.o > 0) rankParts.push(`${cnt.o}å®˜`);
    if (cnt.n > 0) rankParts.push(`${cnt.n}å£«`);
    if (cnt.s > 0) rankParts.push(`${cnt.s}å…µ`);
    if (cnt.t > 0) rankParts.push(`${cnt.t}è¨“`);
    return rankParts.length > 0 ? rankParts.join('') : '0å“¡';
};

function copyCSMReport(){
    const abs = getAbsCount();
    if(abs > 0) return alert(`âš ï¸ é‚„æœ‰ ${abs} å“¡æœªé»åï¼\nè«‹æŒ‰ã€ŒğŸ“¢ æŸ¥æœªåˆ°ã€æŒ‰éˆ•ä¿®æ­£ã€‚`);
    
    const R = calculateStats();
    const tot = R.tot;
    const now = new Date();
    const u = D.u ? D.u : 'æœªè¨­å®šå–®ä½';
    const getName = (raw) => raw.split(/[ï¼ˆ\(]/)[0];
    const allPersonnel = [...D.o,...D.n,...D.s,...D.t];

    const returnLists = {r21: [], r24: [], r07: []};
    const returningNames = [];
    allPersonnel.forEach(name => {
        if(D.st[name] && D.st[name] !== 'p' && D.nt[name]){
            const note = D.nt[name].toLowerCase().replace(/\s/g, '');
            if (note.includes('21æ”¶') && !returningNames.includes(name)) { returnLists.r21.push(name); returningNames.push(name); }
            else if (note.includes('24æ”¶') && !returningNames.includes(name)) { returnLists.r24.push(name); returningNames.push(name); }
            else if (note.includes('07æ”¶') && !returningNames.includes(name)) { returnLists.r07.push(name); returningNames.push(name); }
        }
    });

    let report = `ç‡Ÿå£«ç£å¥½\n\n`;
    report += `${u}å›å ±ï¼ˆ${(now.getMonth()+1)}/${now.getDate()}ï¼‰æ”¶å‡\n`;
    report += `æ‡‰åˆ°ï¼š${R.o.t}å®˜${R.n.t}å£«${R.s.t}å…µ${R.t.t}è¨“\n`; 
    report += `å¯¦åˆ°ï¼š${R.o.p}å®˜${R.n.p}å£«${R.s.p}å…µ${R.t.p}è¨“\n`;
    const allPresent = allPersonnel.filter(n => D.st[n] === 'p' && !n.startsWith('-') && !n.startsWith('#'));
    const presentNames = allPresent.map(getName);
    report += `ï¼ˆ${presentNames.length > 0 ? getName(presentNames[0]) : 'ç„¡'}ç­‰${allPresent.length}å“¡ï¼‰\n\n`;

    const lists = [
        {time: '21æ”¶å‡', data: returnLists.r21},
        {time: '24æ”¶å‡', data: returnLists.r24},
        {time: '07æ”¶å‡', data: returnLists.r07}
    ];
    lists.forEach(item => {
        const list = item.data;
        const count = list.length;
        if(count === 0){
            report += `${item.time}ï¼šç„¡\n`;
        } else {
            const cnt = getRankCount(list);
            const rankSummary = formatRankSummary(cnt);
            const summary = `${getName(list[0])}ç­‰${count}å“¡ï¼ˆ${rankSummary}ï¼‰`;
            report += `${item.time}ï¼š${summary}\n`;
            report += `${list.map(getName).join('\n')}\n\n`;
        }
    });
    report += 'äº‹æ•…ï¼š\n';
    
    const totalAccidentCount = tot.e - returningNames.length;
    if (totalAccidentCount === 0) {
        report += 'ç„¡äº‹æ•…äººå“¡\n';
    } else {
        for(let [reason, arr] of Object.entries(R.dt)){
            const filteredArr = arr.filter(name => !returningNames.includes(name));
            if(filteredArr.length > 0){
                let cnt = getRankCount(filteredArr);
                const rankSummary = formatRankSummary(cnt);
                report += `${reason}ï¼š${rankSummary}\n`;
                const namesWithNotes = filteredArr.map(nm => {
                    let cleanName = getName(nm);
                    const detailNote = (D.nt && D.nt[nm]) ? D.nt[nm].replace(/2[14]æ”¶|07æ”¶/g, '').replace(/æ”¶/g, '').trim() : '';
                    return detailNote ? `${cleanName}[${detailNote}]` : cleanName;
                });
                report += `${namesWithNotes.join('\n')}\n\n`;
            }
        }
    }
    navigator.clipboard.writeText(report).then(()=>{alert("âœ… å·²è¤‡è£½ç‡Ÿå£«ç£å›å ±ï¼");}).catch(e=>alert("è¤‡è£½å¤±æ•—"));
}

function showHistoryList(){
    const h=getHis(),c=document.getElementById('his-items-container');c.innerHTML='';
    const k=Object.keys(h).sort().reverse();
    if(k.length===0){c.innerHTML='<div style="padding:20px;color:#aaa">ç„¡ç´€éŒ„</div>'}else{
        const m={'am':'â˜€ ä¸Šåˆ','pm':'â›… ä¸‹åˆ','night':'ğŸŒ™ æŸ¥é‹ª'};
        k.forEach(key=>{
            const [d,p]=key.split('_'),pt=m[p]||p;
            const dv=document.createElement('div');dv.className='his-item';dv.style.display='flex';dv.style.justifyContent='space-between';dv.style.padding='12px';dv.style.borderBottom='1px solid #eee';
            dv.innerHTML=`<div style="text-align:left;cursor:pointer" onclick="loadHistoryKey('${key}','${d} ${pt}')"><div style="font-weight:bold">${d}</div><div style="opacity:0.7;font-size:0.9rem">${pt}</div></div><button style="background:#c0392b;color:white;border:none;padding:5px 10px;border-radius:6px" onclick="deleteHistoryKey('${key}')">åˆªé™¤</button>`;
            c.appendChild(dv)
        })
    };
    document.getElementById('his-list-modal').classList.add('show')
}
function closeHisList(){document.getElementById('his-list-modal').classList.remove('show')}
function loadHistoryKey(k,s){const h=getHis();if(!h[k])return alert("éºå¤±");if(confirm(`é‚„åŸ [${s}] ç´€éŒ„?`)){D=h[k];persist();render();fillSetup();alert("âœ… å·²è®€å–");closeHisList();toggleHistory()}}
function deleteHistoryKey(k){if(confirm("ç¢ºå®šåˆªé™¤æ­¤ç´€éŒ„?")){const h=getHis();delete h[k];localStorage.setItem(K_HIS,JSON.stringify(h));updateHisCount();showHistoryList()}}
</script>
</body>
</html>

