<!DOCTYPE html><html lang="zh-TW"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>éƒ¨éšŠé»åç³»çµ±(V22å‚™è¨»ç‰ˆ)</title><style>
:root{--bg:#f0f2f5;--txt:#333;--card:#fff;--border:#eee;--hl:#2c3e50;--btn-txt:#fff}
body.dark{--bg:#000;--txt:#0f0;--card:#111;--border:#0f0;--hl:#0f0;--btn-txt:#000}
body{font-family:sans-serif;background:var(--bg);color:var(--txt);margin:0;padding:10px;text-align:center;user-select:none;padding-bottom:80px;transition:0.3s}
.top-bar{display:flex;gap:5px;margin-bottom:10px;justify-content:center;flex-wrap:wrap}
.btn-big{background:var(--hl);color:var(--btn-txt);border:1px solid var(--hl);padding:10px;border-radius:8px;font-weight:bold;flex:1;cursor:pointer;font-size:0.95rem;min-width:80px}
body.dark .btn-big{border:1px solid #0f0;background:#000;color:#0f0}
body.dark .btn-big:active{background:#0f0;color:#000}
.stats-box{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:5px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:10px;position:sticky;top:0;z-index:99;overflow-x:auto}
.stats-table{width:100%;border-collapse:collapse;font-size:.9rem;color:var(--txt)}
.stats-table th,.stats-table td{padding:8px 2px;border-bottom:1px solid var(--border);text-align:center}
.stats-table th{background:var(--bg);color:var(--txt)}
.r-off{color:#e74c3c;font-weight:bold} .r-nco{color:#3498db;font-weight:bold} .r-sol{color:#27ae60;font-weight:bold} .r-tra{color:#9b59b6;font-weight:bold}
.r-tot{font-weight:bold;background:var(--bg)}
body.dark .r-off, body.dark .r-nco, body.dark .r-sol, body.dark .r-tra{color:#0f0}
.c-pre{color:#27ae60;background:rgba(39,174,96,.1)} .c-exc{color:#f39c12;background:rgba(243,156,18,.1)} .c-abs{color:#c0392b;opacity:.8}
body.dark .c-pre{color:#0f0;background:#000} body.dark .c-exc{color:#ff0;background:#000} body.dark .c-abs{color:#f00}
.detail-board{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:15px;display:none;text-align:left;font-size:.9rem}
.detail-row{background:var(--bg);padding:8px 10px;border-radius:6px;border:1px solid var(--border);color:var(--txt);font-size:.95rem;margin-bottom:6px;line-height:1.4}
.breakdown{font-size:0.85rem;opacity:0.8;margin-left:5px;font-weight:normal}
.name-list{font-weight:normal;font-size:.9rem;margin-top:4px;padding-top:4px;border-top:1px dashed var(--border);display:block;color:var(--txt)}
.setup-area{background:var(--card);padding:15px;border-radius:12px;margin-bottom:20px;display:none;border:2px solid var(--hl);text-align:left}
.setup-area.show{display:block}
textarea, input[type="text"]{width:100%;padding:10px;border-radius:6px;border:1px solid #ccc;box-sizing:border-box;background:var(--card);color:var(--txt);font-size:1rem}
textarea{height:60px;margin-bottom:5px}
input[type="text"]{margin-bottom:10px}
.control-bar{display:flex;gap:10px;margin-bottom:15px;justify-content:center;flex-wrap:wrap}
.btn-mode{padding:8px 12px;border-radius:20px;border:2px solid #7f8c8d;background:0 0;font-weight:bold;color:#555;cursor:pointer}
body.dark .btn-mode{color:#0f0;border-color:#0f0}
.btn-mode.active{background:#e67e22;color:#fff;border-color:#e67e22}
.roster-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:8px}
.p-btn{min-height:70px;border:none;border-radius:8px;color:#fff;font-size:1rem;font-weight:bold;cursor:pointer;position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:4px}
.bg-off{background:#e74c3c} .bg-nco{background:#3498db} .bg-sol{background:#27ae60} .bg-tra{background:#9b59b6}
body.dark .p-btn{border:1px solid #0f0;background:#000;color:#0f0}
.st-pre{background:#555!important;opacity:.5;text-decoration:line-through}
body.dark .st-pre{background:#111!important;border:1px solid #555;color:#555}
.st-pre::after{content:'âœ”';position:absolute;top:4px;right:4px}
.st-exc{background:#f39c12!important;border:2px solid #d35400}
body.dark .st-exc{background:#330!important;color:#ff0;border:1px solid #ff0}
.st-tag{font-size:.7rem;background:rgba(0,0,0,.2);padding:2px 5px;border-radius:4px;margin-top:3px}
.st-note{font-size:.7rem;color:#fff;background:rgba(0,0,0,0.5);padding:1px 4px;border-radius:3px;margin-top:2px;max-width:90%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
body.dark .st-note{color:#000;background:#0f0}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:none;justify-content:center;align-items:center;z-index:200}
.modal.show{display:flex}
.m-content{background:var(--card);padding:20px;border-radius:12px;width:85%;max-width:320px;border:1px solid var(--hl)}
.opts{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
.o-btn{padding:10px 2px;border:none;border-radius:6px;color:#fff;cursor:pointer;font-size:.9rem}
.bg-v{background:#e67e22} .bg-g{background:#2c3e50} .bg-s{background:#c0392b} .bg-d{background:#8e44ad}
.history-panel{background:var(--bg);padding:15px;border-radius:12px;margin-bottom:20px;border:2px solid var(--hl);display:none}
.history-panel.show{display:block}
.date-group{display:flex;gap:5px;margin-bottom:10px}
.date-input{padding:10px;font-size:1.1rem;border-radius:6px;border:1px solid #ccc;box-sizing:border-box;background:var(--card);color:var(--txt)}
.h-btn-group{display:flex;gap:10px}
.help-panel{background:var(--card);padding:15px;border-radius:12px;margin-bottom:20px;border:2px solid var(--hl);display:none;text-align:left;box-shadow:0 4px 10px rgba(0,0,0,0.1)}
.help-panel.show{display:block}
.help-list{padding-left:20px;margin:0;font-size:0.95rem;line-height:1.6;color:var(--txt)}
.help-list li{margin-bottom:8px}
.his-list-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:none;justify-content:center;align-items:center;z-index:250}
.his-list-modal.show{display:flex}
.his-content{background:var(--card);width:90%;max-width:350px;border-radius:12px;padding:15px;max-height:80vh;display:flex;flex-direction:column;border:1px solid var(--hl)}
.his-items{overflow-y:auto;flex:1;margin-bottom:10px;border:1px solid var(--border);border-radius:6px}
.his-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid var(--border);background:var(--card);color:var(--txt)}
.his-info{text-align:left;flex:1}
.his-time{font-weight:bold;font-size:1rem}
.his-period{font-size:0.85rem;opacity:0.7;margin-left:5px}
.copy-btn{width:100%;padding:10px;background:#27ae60;color:white;border:none;border-radius:6px;font-weight:bold;margin-bottom:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:5px}
body.dark .copy-btn{background:#000;border:1px solid #0f0;color:#0f0}
.search-box{margin-bottom:10px;position:relative}
.search-input{width:100%;padding:12px;border-radius:30px;border:2px solid #3498db;text-align:center;font-size:1rem;background:var(--card);color:var(--txt)}
/* V22 Progress Bar */
.progress-bar{height:8px;width:100%;background:#eee;border-radius:4px;margin-top:5px;display:flex;overflow:hidden}
.pb-p{background:#27ae60;height:100%}
.pb-e{background:#f39c12;height:100%}
.pb-a{background:#c0392b;height:100%}
</style></head><body>

<div class="top-bar">
    <button class="btn-big" onclick="toggleSetup()">ğŸ“ è¨­å®š</button>
    <button class="btn-big" style="background:#8e44ad" onclick="toggleHistory()">ğŸ“… æ­·å²</button>
    <button class="btn-big" style="background:#3498db" onclick="toggleHelp()">ğŸ“– èªªæ˜</button>
    <button class="btn-big" style="background:#333;max-width:50px" onclick="toggleTheme()">ğŸŒ™</button>
</div>

<div id="help-area" class="help-panel">
    <h3 style="margin-top:0;color:#2980b9">ğŸ“– V22 æ“ä½œèªªæ˜</h3>
    <ul class="help-list">
        <li><b>ğŸ“ å‚™è¨»åŠŸèƒ½ï¼š</b>é»é¸äº‹æ•…æ™‚ï¼Œå¯åœ¨ä¸Šæ–¹è¼¸å…¥å‚™è¨»(å¦‚:2100è¿”)ï¼Œå›å ±æœƒè‡ªå‹•å¸¶å…¥ã€‚</li>
        <li><b>âš¡ é¤˜å“¡å…¨åˆ°ï¼š</b>æŒ‰ã€Œâš¡ é¤˜å“¡å…¨åˆ°ã€å¯ä¸€éµå°‡æœªé»åäººå“¡è¨­ç‚ºå¯¦åˆ°ã€‚</li>
        <li><b>ğŸ” æœå°‹äººå“¡ï¼š</b>åœ¨ä¸Šæ–¹æœå°‹æ¡†è¼¸å…¥åå­—ï¼Œå¿«é€Ÿéæ¿¾ã€‚</li>
        <li><b>ğŸ“‹ è¤‡è£½å›å ±ï¼š</b>ä¸€éµç”Ÿæˆå«å–®ä½ã€å‚™è¨»çš„å›å ±æ–‡ã€‚</li>
    </ul>
    <div style="text-align:center;margin-top:15px"><button class="btn-big" style="background:#34495e;width:100px" onclick="toggleHelp()">OK</button></div>
</div>

<div id="setup-area" class="setup-area">
    <h3 style="margin-top:0;color:var(--hl)">ğŸ¢ å–®ä½è¨­å®š</h3>
    <input type="text" id="in-unit" placeholder="è¼¸å…¥å–®ä½åç¨± (ä¾‹å¦‚ï¼šæ­¥ä¸€é€£)">
    <h3 style="color:var(--hl)">ğŸ› ï¸ è‡ªè¨‚äº‹æ•…æŒ‰éˆ•</h3>
    <textarea id="in-reasons" style="height:50px" placeholder="é è¨­ï¼šä¼‘å‡,å¤–å®¿,è£œä¼‘,è¡›å“¨,å®‰å®˜..."></textarea>
    <h3>è¼¸å…¥åå–®</h3>
    <div style="color:#e74c3c">ğŸ›‘ è»å®˜</div><textarea id="in-off" placeholder="ç¯„ä¾‹ï¼šé€£é•· å‰¯é€£é•·"></textarea>
    <div style="color:#3498db">ğŸ”· å£«å®˜</div><textarea id="in-nco" placeholder="ç¯„ä¾‹ï¼šå‰¯æ’é•· ç­é•·"></textarea>
    <div style="color:#27ae60">ğŸŸ© å£«å…µ</div><textarea id="in-sol" placeholder="ç¯„ä¾‹ï¼šç‹å°æ˜ æå¤§è¯"></textarea>
    <div style="color:#9b59b6">ğŸŸ£ è¨“å“¡</div><textarea id="in-tra" placeholder="ç¯„ä¾‹ï¼šå¼µä¸‰"></textarea>
    <button class="btn-big" style="background:#27ae60;margin-bottom:10px" onclick="saveData()">âœ… å„²å­˜ä¸¦ç”Ÿæˆ</button>
    <div style="border-top:1px solid #ccc;padding-top:10px;display:flex;gap:10px">
        <button class="btn-big" style="background:#7f8c8d" onclick="exportData()">ğŸ“¤ åŒ¯å‡º</button>
        <button class="btn-big" style="background:#7f8c8d" onclick="importData()">ğŸ“¥ åŒ¯å…¥</button>
    </div>
</div>

<div id="history-area" class="history-panel">
    <h3>ğŸ“… æ™‚æ®µç´€éŒ„</h3>
    <div style="display:flex;justify-content:space-between;margin-bottom:10px;background:var(--card);padding:8px;border-radius:6px;border:1px solid var(--border)">
        <span style="font-size:0.9rem">å·²å­˜: <b id="history-count" style="color:#e67e22">0</b> ç­†</span>
        <button onclick="showHistoryList()" style="background:#3498db;color:white;border:none;padding:5px 10px;border-radius:4px;font-weight:bold">ğŸ‘ï¸ æ¸…å–®</button>
    </div>
    <div class="date-group"><input type="date" id="history-date" class="date-input" style="flex:2"><select id="history-period" class="date-input" style="flex:1.5"><option value="am">â˜€ ä¸Šåˆ</option><option value="pm">â›… ä¸‹åˆ</option><option value="night">ğŸŒ™ å¤œé–“</option></select></div>
    <div class="h-btn-group"><button class="btn-big" style="background:#27ae60" onclick="saveToDate()">ğŸ“¥ å­˜æª”</button><button class="btn-big" style="background:#e67e22" onclick="loadFromDate()">ğŸ“¤ è®€å–</button></div>
    <div style="margin-top:15px;border-top:1px solid #ccc;padding-top:10px"><button class="btn-big" style="background:#c0392b;font-size:0.9rem" onclick="clearHistory()">ğŸ—‘ï¸ æ¸…é™¤å…¨éƒ¨</button></div>
</div>

<button class="copy-btn" onclick="copyReport()">ğŸ“‹ ä¸€éµè¤‡è£½å›å ±å…§å®¹</button>

<div class="stats-box">
    <table class="stats-table"><thead><tr><th>éšç´š</th><th>æ‡‰</th><th>å¯¦</th><th>æ•…</th><th>æœª</th></tr></thead><tbody id="stats-body"></tbody></table>
    <div class="progress-bar" id="p-bar"></div>
</div>
<div id="detail-board" class="detail-board"><b>ğŸ“‹ äº‹æ•…æ˜ç´°:</b> <div id="detail-tags" style="margin-top:5px"></div></div>

<div class="search-box">
    <input type="text" id="search-input" class="search-input" placeholder="ğŸ” è¼¸å…¥åå­—å¿«é€Ÿæ‰¾äºº..." oninput="filterRoster()">
</div>

<div class="control-bar">
    <button id="mode-btn" class="btn-mode" onclick="toggleMode()">âš ï¸ äº‹æ•…: é—œ</button>
    <button class="btn-mode" style="border-color:#27ae60;color:#27ae60" onclick="markAllPresent()">âš¡ é¤˜å“¡å…¨åˆ°</button>
    <button class="btn-mode" style="border-color:#c0392b;color:#c0392b" onclick="showMissing()">ğŸ“¢ æŸ¥æœªåˆ°</button>
    <button class="btn-mode" style="background:#95a5a6;color:#fff;border:none" onclick="resetAll()">ğŸ”„ é‡ç½®</button>
</div>
<div id="roster" class="roster-grid"></div>

<div id="modal" class="modal"><div class="m-content"><h3 id="m-name"></h3>
<div style="margin-bottom:10px"><input id="note-input" type="text" placeholder="å‚™è¨» (å¦‚: 2100è¿”, ç™¼ç‡’...)"></div>
<div style="display:flex;gap:5px;margin-bottom:10px"><input id="custom-r" style="flex:1;padding:8px" placeholder="è‡ªè¨‚åŸå› "><button onclick="subCus()" style="background:#3498db;color:#fff;border:none;border-radius:4px">OK</button></div><div class="opts" id="opts-container"></div><button class="o-btn" style="background:#95a5a6;width:100%;margin-top:10px" onclick="closeM()">å–æ¶ˆ</button></div></div>

<div id="his-list-modal" class="his-list-modal"><div class="his-content"><h3 style="margin-top:0;color:var(--txt)">ğŸ“œ å·²å­˜ç´€éŒ„</h3><div id="his-items-container" class="his-items"></div><button class="btn-big" style="background:#95a5a6;margin-top:5px" onclick="closeHisList()">é—œé–‰</button></div></div>

<script>
const K_CUR='army_v22_cur',K_HIS='army_v22_his',K_THEME='army_v22_theme';
let D={o:[],n:[],s:[],t:[],st:{},nt:{},u:'',rs:''},isM=false,cur='',reportStr='';
const DEFAULT_REASONS = "ä¼‘å‡,å¤–å®¿,è£œä¼‘,è¡›å“¨,å®‰å®˜,æˆ°æƒ…,å…¬å·®,å—è¨“,æ”¯æ´,è½‰è¨º,ä½é™¢,éš”é›¢";

document.addEventListener('DOMContentLoaded',()=>{
    document.getElementById('history-date').valueAsDate=new Date();
    if(localStorage.getItem(K_THEME)==='dark') document.body.classList.add('dark');
    load();updateHisCount();
});

function toggleTheme(){document.body.classList.toggle('dark');localStorage.setItem(K_THEME, document.body.classList.contains('dark')?'dark':'light');}
function copyReport(){if(!reportStr) return alert("ç„¡è³‡æ–™");navigator.clipboard.writeText(reportStr).then(()=>{alert("âœ… å·²è¤‡è£½ï¼");}).catch(e=>alert("è¤‡è£½å¤±æ•—"));}
function exportData(){const data={cur:JSON.parse(localStorage.getItem(K_CUR)||'{}'),his:JSON.parse(localStorage.getItem(K_HIS)||'{}')};prompt("è¤‡è£½å‚™ä»½ç¢¼:",JSON.stringify(data));}
function importData(){const str=prompt("è²¼ä¸Šå‚™ä»½ç¢¼:");if(str){try{const d=JSON.parse(str);if(d.cur&&d.his){localStorage.setItem(K_CUR,JSON.stringify(d.cur));localStorage.setItem(K_HIS,JSON.stringify(d.his));alert("âœ… é‚„åŸæˆåŠŸ");location.reload()}else throw new Error}catch(e){alert("âŒ æ ¼å¼éŒ¯èª¤")}}}
function toggleHelp(){document.getElementById('help-area').classList.toggle('show');document.getElementById('setup-area').classList.remove('show');document.getElementById('history-area').classList.remove('show')}
function toggleSetup(){document.getElementById('setup-area').classList.toggle('show');document.getElementById('help-area').classList.remove('show');document.getElementById('history-area').classList.remove('show')}
function toggleHistory(){document.getElementById('history-area').classList.toggle('show');document.getElementById('setup-area').classList.remove('show');document.getElementById('help-area').classList.remove('show');updateHisCount()}
function getHis(){const r=localStorage.getItem(K_HIS);return r?JSON.parse(r):{}}
function updateHisCount(){const h=getHis();document.getElementById('history-count').innerText=Object.keys(h).length}
function getAbsCount(){const all=[...D.o,...D.n,...D.s,...D.t];let abs=0;all.forEach(n=>{if(!D.st[n])abs++});return abs}
function saveToDate(){const d=document.getElementById('history-date').value,p=document.getElementById('history-period').value;if(!d)return alert("é¸æ—¥æœŸ");const abs=getAbsCount();if(abs>0&&!confirm(`âš ï¸ é‚„æœ‰ ${abs} å“¡æœªåˆ°ï¼ç¢ºå®šå­˜æª”ï¼Ÿ`))return;const k=d+'_'+p,h=getHis();h[k]=JSON.parse(JSON.stringify(D));localStorage.setItem(K_HIS,JSON.stringify(h));updateHisCount();alert("å·²å­˜æª”")}
function loadFromDate(){const d=document.getElementById('history-date').value,p=document.getElementById('history-period').value;loadHistoryKey(d+'_'+p, d)}
function clearHistory(){if(confirm("æ¸…ç©ºæ­·å²ï¼Ÿ"))localStorage.removeItem(K_HIS),updateHisCount(),alert("å·²æ¸…ç©º")}
function parse(t){return t?t.split(/[\s,ã€\n]+/).filter(x=>x.trim()):[]}
function toggleMode(){isM=!isM;const b=document.getElementById('mode-btn');b.innerText=isM?"âš ï¸ äº‹æ•…: é–‹":"âš ï¸ äº‹æ•…: é—œ";b.classList.toggle('active')}
function saveData(){D.u=document.getElementById('in-unit').value.trim();D.rs=document.getElementById('in-reasons').value.trim();D.o=parse(document.getElementById('in-off').value);D.n=parse(document.getElementById('in-nco').value);D.s=parse(document.getElementById('in-sol').value);D.t=parse(document.getElementById('in-tra').value);if(!D.o.length&&!D.n.length&&!D.s.length&&!D.t.length)return alert("è«‹è¼¸å…¥åå­—");persist();render();toggleSetup()}
function persist(){localStorage.setItem(K_CUR,JSON.stringify(D))}
function load(){const r=localStorage.getItem(K_CUR);if(r){D=JSON.parse(r);if(!D.nt)D.nt={};fillSetup();render()}else{toggleSetup()}}
function fillSetup(){document.getElementById('in-unit').value=D.u||'';document.getElementById('in-reasons').value=D.rs||DEFAULT_REASONS;document.getElementById('in-off').value=D.o.join(' ');document.getElementById('in-nco').value=D.n.join(' ');document.getElementById('in-sol').value=D.s.join(' ');document.getElementById('in-tra').value=D.t.join(' ')}
function filterRoster(){const t=document.getElementById('search-input').value.toLowerCase();document.querySelectorAll('.p-btn').forEach(b=>{b.style.display=b.innerText.toLowerCase().includes(t)?'flex':'none'})}
function showMissing(){const m=[...D.o,...D.n,...D.s,...D.t].filter(n=>!D.st[n]);if(m.length===0)return alert("ğŸ‘ å…¨å“¡å·²åˆ°");alert(`ğŸ“¢ æœªåˆ° (${m.length}å“¡)ï¼š\n\n${m.join('ã€')}`)}
// V22 Batch Present
function markAllPresent(){if(confirm("ç¢ºå®šè¦å°‡æ‰€æœ‰ã€Œæœªé»åã€çš„äººè¨­ç‚ºã€Œå¯¦åˆ°ã€å—ï¼Ÿ\n(åŸæœ¬çš„äº‹æ•…ä¸æœƒè¢«è¦†è“‹)")){[...D.o,...D.n,...D.s,...D.t].forEach(n=>{if(!D.st[n])D.st[n]='p'});persist();render()}}

function render(){
    const c=document.getElementById('roster');c.innerHTML='';
    const add=(nm,cls)=>{
        const b=document.createElement('button');b.className=`p-btn ${cls}`;
        const s=D.st[nm];const note=D.nt?D.nt[nm]:'';
        let h=`<span>${nm}</span>`;
        if(s&&s!=='p')h+=`<span class="st-tag">${s}</span>`;
        if(note)h+=`<span class="st-note">${note}</span>`;
        b.innerHTML=h;
        if(s==='p')b.classList.add('st-pre');else if(s)b.classList.add('st-exc');
        b.onclick=()=>{
            if(isM){
                cur=nm;document.getElementById('m-name').innerText=nm;
                document.getElementById('custom-r').value='';
                document.getElementById('note-input').value=D.nt&&D.nt[nm]?D.nt[nm]:'';
                renderModalOpts();document.getElementById('modal').classList.add('show');
            }else{D.st[nm]=(D.st[nm]==='p'?null:'p');persist();render()}
        };c.appendChild(b)
    };
    D.o.forEach(x=>add(x,'bg-off'));D.n.forEach(x=>add(x,'bg-nco'));D.s.forEach(x=>add(x,'bg-sol'));D.t.forEach(x=>add(x,'bg-tra'));
    updT();filterRoster();
}
function renderModalOpts(){
    const c=document.getElementById('opts-container');c.innerHTML='';
    (D.rs||DEFAULT_REASONS).split(/[,ï¼Œ]/).map(x=>x.trim()).filter(x=>x).forEach(r=>{
        const b=document.createElement('button');b.className='o-btn bg-v';
        if(['è¡›å“¨','å®‰å®˜','æˆ°æƒ…'].includes(r))b.className='o-btn bg-g';
        if(['è½‰è¨º','ä½é™¢','éš”é›¢'].includes(r))b.className='o-btn bg-s';
        if(['å…¬å·®','å—è¨“','æ”¯æ´'].includes(r))b.className='o-btn bg-d';
        b.innerText=r;b.onclick=()=>setS(r);c.appendChild(b)
    });
    const r=document.createElement('button');r.className='o-btn';r.style.background='#1abc9c';r.style.gridColumn='span 3';r.innerText='ç„¡äº‹æ•… (è¿”å›æœªåˆ°)';r.onclick=()=>setS(null);c.appendChild(r)
}
function subCus(){const v=document.getElementById('custom-r').value.trim();if(v)setS(v)}
function setS(v){
    D.st[cur]=v;
    const n=document.getElementById('note-input').value.trim();
    if(!D.nt)D.nt={};
    if(n)D.nt[cur]=n;else delete D.nt[cur];
    closeM();persist();render()
}
function closeM(){document.getElementById('modal').classList.remove('show')}
function resetAll(){if(confirm("é‡ç½®ç‹€æ…‹?"))D.st={},persist(),render()}
function updT(){
    const calc=(l,k,res)=>{l.forEach(n=>{const s=D.st[n];if(s==='p')res[k].p++;else if(s){res[k].e++;if(!res.dt[s])res.dt[s]=[];res.dt[s].push(n)}})};
    const R={o:{t:D.o.length,p:0,e:0},n:{t:D.n.length,p:0,e:0},s:{t:D.s.length,p:0,e:0},t:{t:D.t.length,p:0,e:0},dt:{}};
    calc(D.o,'o',R);calc(D.n,'n',R);calc(D.s,'s',R);calc(D.t,'t',R);
    const tot={t:R.o.t+R.n.t+R.s.t+R.t.t,p:R.o.p+R.n.p+R.s.p+R.t.p,e:R.o.e+R.n.e+R.s.e+R.t.e};
    const r=document.getElementById('stats-body');
    const row=(l,c,d)=>`<tr><td class="${c}">${l}</td><td>${d.t}</td><td class="c-pre">${d.p}</td><td class="c-exc">${d.e}</td><td class="c-abs">${d.t-d.p-d.e}</td></tr>`;
    r.innerHTML=row('è»å®˜','r-off',R.o)+row('å£«å®˜','r-nco',R.n)+row('å£«å…µ','r-sol',R.s)+row('è¨“å“¡','r-tra',R.t)+`<tr style="background:#eee;color:#000"><td class="r-tot">åˆ</td><td class="r-tot">${tot.t}</td><td class="r-tot c-pre">${tot.p}</td><td class="r-tot c-exc">${tot.e}</td><td class="r-tot c-abs">${tot.t-tot.p-tot.e}</td></tr>`;
    
    // V22 Progress Bar
    const pb=document.getElementById('p-bar');
    if(tot.t>0){
        const pp=(tot.p/tot.t)*100,ep=(tot.e/tot.t)*100,ap=((tot.t-tot.p-tot.e)/tot.t)*100;
        pb.innerHTML=`<div class="pb-p" style="width:${pp}%"></div><div class="pb-e" style="width:${ep}%"></div><div class="pb-a" style="width:${ap}%"></div>`;
    }

    const db=document.getElementById('detail-board'),dt=document.getElementById('detail-tags');dt.innerHTML='';
    let now=new Date(),u=D.u?D.u:"";
    reportStr=`ã€éƒ¨éšŠé»åå›å ±ã€‘\nå–®ä½ï¼š${u}\næ™‚é–“ï¼š${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')} (${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')})\n`;
    reportStr+=`æ‡‰åˆ°ï¼š${tot.t}å“¡ (å®˜${D.o.length} å£«${D.n.length} å…µ${D.s.length} è¨“${D.t.length})\nå¯¦åˆ°ï¼š${tot.p}å“¡ (å®˜${R.o.p} å£«${R.n.p} å…µ${R.s.p} è¨“${R.t.p})\näº‹æ•…ï¼š${tot.e}å“¡ (å®˜${R.o.e} å£«${R.n.e} å…µ${R.s.e} è¨“${R.t.e})\næœªåˆ°ï¼š${tot.t-tot.p-tot.e}å“¡\n----------------\n`;
    if(tot.e>0){
        db.style.display='block';
        for(let[k,arr]of Object.entries(R.dt)){
            let co=0,cn=0,cs=0,ct=0;
            arr.forEach(nm=>{if(D.o.includes(nm))co++;else if(D.n.includes(nm))cn++;else if(D.s.includes(nm))cs++;else if(D.t.includes(nm))ct++});
            // V22 Report with notes
            let namesWithNotes = arr.map(nm => D.nt && D.nt[nm] ? `${nm}[${D.nt[nm]}]` : nm);
            let nameSummary = namesWithNotes.length > 1 ? `${namesWithNotes[0]}ç­‰${namesWithNotes.length}å“¡` : namesWithNotes[0];
            reportStr+=`${k}ï¼š${arr.length}å“¡ (${nameSummary})\n`;
            dt.innerHTML+=`<div class="detail-row"><b>${k}: ${arr.length}å“¡</b> <span class="breakdown">(å®˜${co} å£«${cn} å…µ${cs} è¨“${ct})</span><span class="name-list">(${namesWithNotes.join(' ')})</span></div>`
        }
    }else{db.style.display='none';reportStr+="ç„¡äº‹æ•…äººå“¡\n"}
}
function showHistoryList(){const h=getHis(),c=document.getElementById('his-items-container');c.innerHTML='';const k=Object.keys(h).sort().reverse();if(k.length===0){c.innerHTML='<div style="padding:20px;color:#aaa">ç„¡ç´€éŒ„</div>'}else{const m={'am':'â˜€ ä¸Šåˆ','pm':'â›… ä¸‹åˆ','night':'ğŸŒ™ å¤œé–“'};k.forEach(key=>{const [d,p]=key.split('_'),pt=m[p]||p;const dv=document.createElement('div');dv.className='his-item';dv.innerHTML=`<div class="his-info" onclick="loadHistoryKey('${key}','${d} ${pt}')"><div class="his-time">${d}</div><div class="his-period">${pt}</div></div><button style="background:#c0392b;color:white;border:none;padding:5px;border-radius:4px;margin-left:10px" onclick="deleteHistoryKey('${key}')">ğŸ—‘ï¸</button>`;c.appendChild(dv)})};document.getElementById('his-list-modal').classList.add('show')}
function closeHisList(){document.getElementById('his-list-modal').classList.remove('show')}
function loadHistoryKey(k,s){const h=getHis();if(!h[k])return alert("éºå¤±");if(confirm(`é‚„åŸ [${s}] ?`)){D=h[k];persist();render();fillSetup();alert("å·²è®€å–");closeHisList();toggleHistory()}}
function deleteHistoryKey(k){if(confirm("åˆªé™¤?")){const h=getHis();delete h[k];localStorage.setItem(K_HIS,JSON.stringify(h));updateHisCount();showHistoryList()}}
</script></body></html>
